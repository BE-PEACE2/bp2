<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Payment Success - BE PEACE</title>

  <meta name="description" content="Your booking with BE PEACE was successful. Expect expert pediatric and general health advice from Dr. Mahesh Yadav.">
  <meta property="og:title" content="Booking Successful - BE PEACE">
  <meta property="og:description" content="Your consultation booking is confirmed. You will receive expert care from Dr. Mahesh Yadav.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://bepeace.in/payment-success.html">
  <meta property="og:image" content="https://bepeace.in/images/doctor.jpg">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Booking Successful - BE PEACE">
  <meta name="twitter:description" content="Your consultation booking is confirmed with Dr. Mahesh Yadav.">
  <meta name="twitter:image" content="https://bepeace.in/images/doctor.jpg">

  <link rel="stylesheet" href="style.css">
  <style>
    body { font-family: Arial, sans-serif; background: #fff; margin: 0; padding: 0; }
    .success-message { text-align: center; padding: 60px 20px; color: #28a745; }
    .success-message h2 { font-size: 28px; margin-bottom: 15px; }
    .success-message p { font-size: 18px; color: #333; }
    .highlight { font-size: 20px; font-weight: bold; color: #0077cc; margin-top: 10px; }
    .details {
      margin-top: 25px; font-size: 18px; color: #444; text-align: left;
      max-width: 500px; margin-left: auto; margin-right: auto;
      background: #f9f9f9; padding: 20px; border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .details p { margin: 8px 0; }
    .back-btn {
      display: inline-block; margin: 20px 10px 0; padding: 12px 22px;
      background: #28a745; color: #fff; text-decoration: none; border-radius: 5px;
      font-size: 16px; transition: all 0.3s ease;
    }
    .back-btn:hover { opacity: 0.9; transform: translateY(-2px); }
    .alt-btn { background: #0077cc; }
    .download-btn { background: #6f42c1; }
    .redirect-note { margin-top: 15px; font-size: 14px; color: #777; }
  </style>
</head>

<body>
  <!-- Header -->
  <header>
    <div class="logo-container">
      <div class="earth"></div>
      <h1 class="peach-text">BE PEACE</h1>
    </div>
  </header>

  <!-- Success Message -->
  <section class="success-message">
    <h2>‚úÖ Payment Successful!</h2>
    <p>Thank you for booking your consultation. You will receive a confirmation email shortly.</p>

    <p class="highlight">üìå Booking Reference: <span id="orderId"></span></p>

    <div class="details" id="receipt">
      <p id="name"></p>
      <p id="email"></p>
      <p id="phone"></p>
      <p id="age"></p>
      <p id="sex"></p>
      <p id="amount"></p>
    </div>

    <a href="index.html" class="back-btn">üè† Back to Homepage</a>
    <a href="booking.html" class="back-btn alt-btn">üìÖ Book Another Consultation</a>
    <button id="downloadBtn" class="back-btn download-btn">üìÑ Download Receipt</button>

    <p class="redirect-note">‚è≥ Redirecting to homepage in <span id="countdown">15</span> seconds...</p>
  </section>

  <footer>
    <div class="footer-logo">
      <div class="earth slow"></div>
      <h1 class="peach-text">BE PEACE</h1>
    </div>
    <p>¬© 2025 BE PEACE. All rights reserved.</p>
  </footer>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <script>
    // ‚è≥ Countdown Redirect
    let seconds = 15;
    const countdownEl = document.getElementById("countdown");
    const timer = setInterval(() => {
      seconds--;
      if (countdownEl) countdownEl.textContent = seconds;
      if (seconds <= 0) {
        clearInterval(timer);
        window.location.href = "index.html";
      }
    }, 1000);

    // ‚úÖ Corrected verifyPayment function
async function verifyPayment() {
  const params = new URLSearchParams(window.location.search);
  const orderId = params.get("order_id");
  if (!orderId) {
    document.querySelector(".success-message h2").textContent = "‚ö†Ô∏è Missing Order ID";
    return;
  }
  document.getElementById("orderId").textContent = orderId;

  try {
    // ‚úÖ Use GET instead of POST (match your backend)
    const res = await fetch(`/api/payment?path=verify&order_id=${orderId}`);
    const data = await res.json();

    console.log("Verification result:", data);

    // ‚úÖ Check for both PAID and SUCCESS statuses
    if (data.order_status === "PAID" || data.order_status === "SUCCESS") {
      document.querySelector(".success-message h2").textContent = "‚úÖ Payment Verified Successfully!";
      document.querySelector(".success-message h2").style.color = "green";

      // Fill details from localStorage or API
      document.getElementById("amount").textContent = "üí∞ Amount Paid: ‚Çπ" + (data.order_amount || "10");
      document.getElementById("name").textContent = "üë§ Name: " + (localStorage.getItem("name") || "‚Äî");
      document.getElementById("email").textContent = "üìß Email: " + (localStorage.getItem("email") || "‚Äî");
      document.getElementById("phone").textContent = "üì± Phone: " + (localStorage.getItem("phone") || "‚Äî");
      document.getElementById("age").textContent = "üéÇ Age: " + (localStorage.getItem("age") || "‚Äî");
      document.getElementById("sex").textContent = "‚öß Sex: " + (localStorage.getItem("sex") || "‚Äî");
    } else {
      document.querySelector(".success-message h2").textContent = "‚ö†Ô∏è Payment Verification Failed";
      document.querySelector(".success-message h2").style.color = "red";
    }
  } catch (err) {
    console.error("Verification error:", err);
    document.querySelector(".success-message h2").textContent = "‚ö†Ô∏è Server Verification Error";
    document.querySelector(".success-message h2").style.color = "red";
  }
}
verifyPayment();

    // üíö BE PEACE Receipt ‚Äì With Faint Logo Watermark
document.getElementById("downloadBtn").addEventListener("click", () => {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF("p", "mm", "a4");

  const logoUrl = "https://bepeace.in/images/logo.svg"; // Your official logo
  const img = new Image();
  img.crossOrigin = "Anonymous";
  img.src = logoUrl;

  img.onload = function () {
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();

    // üåø Add faint logo watermark in center
    const watermarkSize = 90;
    const watermarkX = (pageWidth - watermarkSize) / 2;
    const watermarkY = (pageHeight - watermarkSize) / 2 - 10;

    doc.saveGraphicsState();
    doc.setGState(new doc.GState({ opacity: 0.08 }));
    doc.addImage(img, "PNG", watermarkX, watermarkY, watermarkSize, watermarkSize);
    doc.restoreGraphicsState();

    // üåø Add small shimmer "BE PEACE" text watermark
    doc.saveGraphicsState();
    doc.setFontSize(60);
    doc.setTextColor(200, 240, 200);
    doc.text("BE PEACE", pageWidth / 2, pageHeight / 2, {
      align: "center",
      angle: 45,
      opacity: 0.05,
    });
    doc.restoreGraphicsState();

    // üåø Top Header Logo
    const logoWidth = 45;
    const logoX = (pageWidth - logoWidth) / 2;
    doc.addImage(img, "PNG", logoX, 12, logoWidth, 35);

    doc.setFontSize(18);
    doc.setTextColor(0, 100, 0);
    doc.text("BE PEACE", pageWidth / 2, 55, { align: "center" });

    doc.setFontSize(12);
    doc.setTextColor(70);
    doc.text("Worldwide Online Teleconsultation", pageWidth / 2, 61, { align: "center" });
    doc.text("www.bepeace.in", pageWidth / 2, 66, { align: "center" });

    doc.setFontSize(14);
    doc.setTextColor(0);
    doc.text("Consultation Receipt", pageWidth / 2, 76, { align: "center" });

    // üßæ Table Data
    const clean = (str) =>
      (str || "").replace(/[^\x00-\x7F]/g, "").replace(/.*:\s*/, "");
    const transactionId = localStorage.getItem("transaction_id") || "CF-" + Date.now();

    const rows = [
      ["Booking Reference", document.getElementById("orderId").textContent],
      ["Name", clean(localStorage.getItem("name") || "‚Äî")],
      ["Email", clean(localStorage.getItem("email") || "‚Äî")],
      ["Phone", clean(localStorage.getItem("phone") || "‚Äî")],
      ["Age", clean(localStorage.getItem("age") || "‚Äî")],
      ["Sex", clean(localStorage.getItem("sex") || "‚Äî")],
      ["Consultation Date", clean(localStorage.getItem("date") || "‚Äî")],
      ["Consultation Slot", clean(localStorage.getItem("slot") || "‚Äî")],
      ["Amount Paid", clean(document.getElementById("amount").textContent.replace(/[^\d‚Çπ]/g, ""))],
      ["Transaction ID", transactionId],
    ];

    doc.autoTable({
      startY: 82,
      head: [["Field", "Details"]],
      body: rows,
      theme: "grid",
      styles: { fontSize: 12, cellPadding: 5 },
      headStyles: { fillColor: [0, 120, 80], textColor: 255 },
      alternateRowStyles: { fillColor: [245, 250, 245] },
    });

    // üíö Divider + Message
    const msgY = doc.lastAutoTable.finalY + 12;
    doc.setDrawColor(150, 220, 150);
    doc.setLineWidth(0.4);
    doc.line(40, msgY, pageWidth - 40, msgY);

    const textY = msgY + 8;
    doc.setFontSize(13);
    doc.setTextColor(0, 100, 0);
    doc.text("Thank you for trusting BE PEACE üíö", pageWidth / 2, textY, { align: "center" });
    doc.setFontSize(12);
    doc.setTextColor(60);
    doc.text("Your health, Your peace.", pageWidth / 2, textY + 6, { align: "center" });

    // üìÖ Footer
    const date = new Date().toLocaleString();
    const footerY = pageHeight - 25;

    doc.setDrawColor(0, 120, 80);
    doc.line(20, footerY, pageWidth - 20, footerY);

    doc.setFontSize(10);
    doc.setTextColor(90);
    doc.text(`Generated on: ${date}`, 20, footerY + 6);
    doc.setTextColor(60);
    doc.text("BE PEACE | Worldwide Online Teleconsultation", pageWidth / 2, footerY + 12, { align: "center" });
    doc.text("Support: info@bepeace.in", pageWidth / 2, footerY + 17, { align: "center" });

    // üíæ Save
    doc.save("BEPEACE_Consultation_Receipt.pdf");
  };
});
  </script>
</body>
</html>