<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Payment Success - BE PEACE</title>

  <meta name="description" content="Your BE PEACE consultation payment verification page." />
  <meta property="og:title" content="Booking Successful - BE PEACE" />
  <meta property="og:description" content="Your consultation booking has been confirmed." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://bepeace.in/payment-success.html" />

  <style>
    body {
      margin: 0;
      font-family: "Poppins", Arial, sans-serif;
      background: #f8f9fa;
      color: #333;
      text-align: center;
    }

    header, footer {
      padding: 20px;
      background: #f0f0f0;
    }

    h1.peach-text {
      color: #0077cc;
      font-size: 28px;
      margin: 10px 0;
    }

    .container {
      margin-top: 60px;
      padding: 20px;
    }

    .icon-wrapper {
      width: 90px;
      height: 90px;
      margin: 0 auto 20px;
      position: relative;
    }

    .circle {
      width: 90px;
      height: 90px;
      border-radius: 50%;
      border: 6px solid #0077cc;
      border-top-color: transparent;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin {
      100% { transform: rotate(360deg); }
    }

    .checkmark, .cross {
      position: absolute;
      top: 22px;
      left: 26px;
      font-size: 44px;
      display: none;
    }

    .success { color: #28a745; }
    .failed { color: #dc3545; }

    h2 {
      font-size: 24px;
      margin-top: 15px;
    }

    .highlight {
      font-weight: bold;
      color: #0077cc;
      font-size: 18px;
      margin-top: 10px;
    }

    .details {
      background: white;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
      border-radius: 10px;
      padding: 20px;
      max-width: 500px;
      margin: 20px auto;
      text-align: left;
    }

    .details p { margin: 8px 0; font-size: 16px; }

    .btn {
      padding: 10px 20px;
      margin: 10px;
      border-radius: 5px;
      border: none;
      font-size: 16px;
      color: white;
      cursor: pointer;
      transition: 0.3s;
    }

    .btn:hover { opacity: 0.9; transform: translateY(-2px); }
    .green { background: #28a745; }
    .blue { background: #0077cc; }
    .purple { background: #6f42c1; }

    .redirect-note {
      font-size: 14px;
      color: #777;
      margin-top: 15px;
    }

    .fade-in {
      opacity: 0;
      animation: fadeIn 0.5s ease forwards;
    }

    @keyframes fadeIn {
      to { opacity: 1; }
    }
  </style>
</head>
<body>

  <header>
    <h1 class="peach-text">üåç BE PEACE</h1>
  </header>

  <section class="container">
    <div class="icon-wrapper">
      <div class="circle" id="spinner"></div>
      <div class="checkmark success fade-in" id="successMark">‚úÖ</div>
      <div class="cross failed fade-in" id="failMark">‚ö†Ô∏è</div>
    </div>

    <h2 id="statusText">Verifying your payment...</h2>
    <p class="highlight">üìå Booking Reference: <span id="orderId"></span></p>

    <div class="details fade-in" id="receipt" style="display:none;">
      <p id="name"></p>
      <p id="email"></p>
      <p id="phone"></p>
      <p id="age"></p>
      <p id="sex"></p>
      <p id="amount"></p>
    </div>

    <div>
      <a href="index.html"><button class="btn green">üè† Home</button></a>
      <a href="booking.html"><button class="btn blue">üìÖ Book Again</button></a>
      <button id="downloadBtn" class="btn purple">üìÑ Download Receipt</button>
    </div>

    <p class="redirect-note">‚è≥ Redirecting to homepage in <span id="countdown">10</span> seconds...</p>
  </section>

  <footer>
    <p>¬© 2025 BE PEACE. All rights reserved.</p>
  </footer>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

  <script>
    const orderIdEl = document.getElementById("orderId");
    const spinner = document.getElementById("spinner");
    const successMark = document.getElementById("successMark");
    const failMark = document.getElementById("failMark");
    const statusText = document.getElementById("statusText");
    const receipt = document.getElementById("receipt");

    async function verifyPayment() {
      const params = new URLSearchParams(window.location.search);
      const orderId = params.get("order_id");
      if (!orderId) {
        statusText.textContent = "‚ö†Ô∏è Missing Order ID";
        spinner.style.display = "none";
        failMark.style.display = "block";
        return;
      }
      orderIdEl.textContent = orderId;

      try {
        // Give server 2 seconds for webhook update
        await new Promise(resolve => setTimeout(resolve, 2000));
        const res = await fetch(`/api/payment?path=verify&order_id=${orderId}`);
        const data = await res.json();

        console.log("Verification result:", data);

        if (["PAID", "SUCCESS"].includes(data.order_status)) {
          spinner.style.display = "none";
          successMark.style.display = "block";
          statusText.textContent = "‚úÖ Payment Verified Successfully!";
          statusText.style.color = "#28a745";

          receipt.style.display = "block";
          document.getElementById("amount").textContent = "üí∞ Amount Paid: ‚Çπ" + (data.order_amount || "‚Äî");
          document.getElementById("name").textContent = "üë§ Name: " + (localStorage.getItem("name") || "‚Äî");
          document.getElementById("email").textContent = "üìß Email: " + (localStorage.getItem("email") || "‚Äî");
          document.getElementById("phone").textContent = "üì± Phone: " + (localStorage.getItem("phone") || "‚Äî");
          document.getElementById("age").textContent = "üéÇ Age: " + (localStorage.getItem("age") || "‚Äî");
          document.getElementById("sex").textContent = "‚öß Sex: " + (localStorage.getItem("sex") || "‚Äî");
        } else {
          spinner.style.display = "none";
          failMark.style.display = "block";
          statusText.textContent = "‚ö†Ô∏è Payment Verification Failed";
          statusText.style.color = "#dc3545";
        }
      } catch (err) {
        console.error("Verification error:", err);
        spinner.style.display = "none";
        failMark.style.display = "block";
        statusText.textContent = "‚ö†Ô∏è Server Verification Error";
      }
    }
    verifyPayment();

    // üßæ Download PDF Receipt
    document.getElementById("downloadBtn").addEventListener("click", () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(18);
      doc.text("BE PEACE - Consultation Receipt", 20, 20);

      const rows = [
        ["Booking Reference", document.getElementById("orderId").textContent],
        ["Name", document.getElementById("name").textContent],
        ["Email", document.getElementById("email").textContent],
        ["Phone", document.getElementById("phone").textContent],
        ["Age", document.getElementById("age").textContent],
        ["Sex", document.getElementById("sex").textContent],
        ["Amount Paid", document.getElementById("amount").textContent],
      ];

      doc.autoTable({
        startY: 35,
        head: [["Field", "Details"]],
        body: rows,
        theme: "grid",
        styles: { fontSize: 12, cellPadding: 5 },
        headStyles: { fillColor: [40, 167, 69] },
      });

      const date = new Date().toLocaleString();
      doc.setFontSize(10);
      doc.text("Generated on: " + date, 20, doc.internal.pageSize.height - 10);
      doc.save("BEPEACE_Receipt.pdf");
    });

    // ‚è≥ Auto redirect countdown
    let seconds = 10;
    const countdownEl = document.getElementById("countdown");
    const timer = setInterval(() => {
      seconds--;
      countdownEl.textContent = seconds;
      if (seconds <= 0) {
        clearInterval(timer);
        window.location.href = "index.html";
      }
    }, 1000);
  </script>
</body>
</html>