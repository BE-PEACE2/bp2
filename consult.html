<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>BE PEACE — Virtual Waiting Room</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="/style.css" />
  <style>
    body,html {
      height:100%;
      margin:0;
      font-family:Arial,Helvetica,sans-serif;
      background:#f9f9f9;
    }
    header, footer {
      text-align:center;
      padding:10px 0;
    }
    main {
      min-height:80vh;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .card {
      background:#fff;
      padding:24px;
      border-radius:10px;
      box-shadow:0 6px 20px rgba(0,0,0,0.08);
      max-width:520px;
      width:90%;
      text-align:center;
    }
    h2 { color:#c71585; margin-bottom:10px; }
    input, select, button {
      padding:10px 12px;
      border-radius:6px;
      border:1px solid #ccc;
      font-size:16px;
      width:90%;
    }
    button {
      background:#c71585;
      color:#fff;
      border:none;
      margin-top:10px;
      cursor:pointer;
      transition:all 0.2s;
    }
    button:hover {
      background:#a5106f;
    }
    #queueInfo { margin-top:14px; color:#333; }
  </style>
</head>
<body>
  <!-- HEADER -->
  <header>
    <div class="logo-container">
      <div class="earth"></div>
      <h1 class="peach-text">BE PEACE</h1>
    </div>
    <h2>Virtual Waiting Room</h2>
  </header>

  <main>
    <div class="card">
      <h3>Enter Details to Join the Waiting Room</h3>
      <p>Pay & wait for the doctor to start your consultation.</p>

      <div id="joinForm">
        <input id="name" placeholder="Full name" /><br/><br/>
        <input id="email" type="email" placeholder="Email (optional)"/><br/><br/>
        <input id="phone" placeholder="Phone (optional)" /><br/><br/>
        <select id="purpose">
          <option value="general_consultation">General Consultation - ₹499</option>
        </select><br/><br/>
        <button id="joinBtn" onclick="startPayment()">Pay ₹499 & Join Waiting Room</button>
      </div>

      <div id="afterJoin" style="display:none">
        <p id="queueInfo">Joining queue...</p>
        <p style="font-size:13px;color:#666">
          Keep this page open — you'll be redirected automatically when the doctor calls you.
        </p>
      </div>
    </div>
  </main>

  <!-- FOOTER -->
  <footer>
    <p>© 2025 BE PEACE. All rights reserved.</p>
  </footer>

  <script>
    // ===== CONFIG =====
    const PAYMENT_API = "/api/payment?path=create-walkin";
    const WAITING_JOIN_API = "/api/waiting?path=join";
    const WAITING_STATUS_API = "/api/waiting?path=status"; // ?orderId=

    const DEFAULT_AMOUNT = 499; // ₹

    // ===== HELPERS =====
    const qs = name => new URLSearchParams(window.location.search).get(name);

    // ===== STEP 1: INITIATE PAYMENT =====
    async function startPayment(){
      const name = document.getElementById("name").value.trim();
      const email = document.getElementById("email").value.trim();
      const phone = document.getElementById("phone").value.trim();
      const purpose = document.getElementById("purpose").value;

      if(!name) return alert("Please enter your name");

      const btn = document.getElementById("joinBtn");
      btn.disabled = true;
      btn.innerText = "Creating payment...";

      try {
        const res = await fetch(PAYMENT_API, {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({ name, email, phone, purpose, amount: DEFAULT_AMOUNT })
        });
        const data = await res.json();
        if(!data.success || !data.paymentUrl) throw new Error(data.message || "Order creation failed");

        // Redirect to Cashfree hosted page
        window.location.href = data.paymentUrl;
      } catch (err) {
        console.error(err);
        alert("Payment initialization failed. Try again.");
        btn.disabled = false;
        btn.innerText = "Pay ₹499 & Join Waiting Room";
      }
    }

    // ===== STEP 2: AFTER PAYMENT SUCCESS =====
    async function onLoadAfterPayment() {
      const payment = qs("payment");
      const orderId = qs("orderId");
      if(payment === "success" && orderId) {
        document.getElementById("joinForm").style.display = "none";
        document.getElementById("afterJoin").style.display = "block";
        document.getElementById("queueInfo").innerText = "Verifying payment...";

        try {
          const res = await fetch(WAITING_JOIN_API, {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({ orderId })
          });
          const d = await res.json();
          if(!d.success) throw new Error(d.message || "Failed to join waiting room");

          document.getElementById("queueInfo").innerText =
            `✅ You joined the queue as number ${d.position}. Please wait for your turn.`;

          pollStatus(orderId);
        } catch (err) {
          console.error(err);
          document.getElementById("queueInfo").innerText = "❌ Failed to join waiting room. Please contact support.";
        }
      }
    }

    // ===== STEP 3: POLL PATIENT STATUS =====
    async function pollStatus(orderId){
      try {
        const res = await fetch(`${WAITING_STATUS_API}&orderId=${encodeURIComponent(orderId)}`);
        const d = await res.json();
        if(d.status === "consulting" && d.roomName){
          // Redirect to consultation room
          window.location.href = `/consult-room.html?room=${encodeURIComponent(d.roomName)}&orderId=${encodeURIComponent(orderId)}&name=${encodeURIComponent(d.patientName || "Patient")}`;
          return;
        }
        if(d.position) {
          document.getElementById("queueInfo").innerText =
            `⏳ You are number ${d.position} in the queue. Doctor will call you soon.`;
        }
      } catch (e) {
        console.error("poll error", e);
      }
      setTimeout(()=> pollStatus(orderId), 5000);
    }

    // ===== AUTO CHECK ON LOAD =====
    window.addEventListener("DOMContentLoaded", onLoadAfterPayment);
  </script>
</body>
</html>