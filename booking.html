<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Book Consultation - BE PEACE</title>

  <!-- SEO -->
  <meta name="description" content="Book an online pediatric or general health consultation with BE PEACE. Simple, fast, and trusted video consultations.">
  <meta property="og:title" content="Book a Consultation ‚Äì BE PEACE">
  <meta property="og:description" content="Schedule your online health consultation with BE PEACE today. Trusted by families worldwide.">
  <meta property="og:url" content="https://bepeace.in/booking.html">
  <meta property="og:image" content="https://bepeace.in/images/doctor.jpg">
  <meta name="twitter:card" content="summary_large_image">

  <link rel="stylesheet" href="style.css">

  <!-- Cashfree v3 SDK (LIVE only) -->
  <script src="https://sdk.cashfree.com/js/v3/cashfree.js"></script>

  <!-- ‚úÖ intl-tel-input CSS + JS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.19/css/intlTelInput.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.19/js/intlTelInput.min.js"></script>

  <!-- ‚úÖ Select2 (searchable dropdown) -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0/js/select2.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; background: #fff; margin: 0; padding: 0; }
    h2 { text-align: center; color: #c71585; margin: 25px 0; }
    form {
      background: white;
      padding: 25px;
      border-radius: 10px;
      max-width: 650px;
      margin: auto;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    label { font-weight: bold; display: block; margin: 10px 0 5px; }
    input, select, textarea {
      width: 100%; padding: 12px; margin-bottom: 15px;
      border-radius: 5px; border: 1px solid #ccc;
      font-size: 1rem; height: 44px; box-sizing: border-box;
    }
    textarea { height: auto; min-height: 100px; }
    input:focus, select:focus, textarea:focus {
      border-color: #00bfff;
      box-shadow: 0 0 8px rgba(0,191,255,0.5);
      outline: none;
    }
    .fee { font-size: 18px; color: #0077cc; font-weight: bold; margin: 10px 0; }
    .success { color: green; font-size: 0.95rem; display: none; margin: 10px 0; font-weight: bold; }
    .calendly-inline-widget {
      margin-top: 20px; min-width: 320px; height: 630px; border: none;
    }
    button {
      background: #ccc; color: white; padding: 12px;
      border: none; border-radius: 5px;
      font-size: 16px; cursor: not-allowed; width: 100%;
      transition: all 0.3s ease;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    }
    button.active {
      background: #28a745;
      cursor: pointer;
    }
    button.active:hover {
      box-shadow: 0 6px 15px rgba(40,167,69,0.6);
      transform: translateY(-2px);
    }
    .back-btn {
      display: block; text-align: center; margin-top: 12px;
      color: #0077cc; text-decoration: none;
    }

     /* ‚úÖ Slots grid */
    .slots-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 10px;
      margin: 10px 0 20px;
    }
    .slot-btn {
      padding: 10px;
      border-radius: 6px;
      font-size: 14px;
      border: none;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s;
    }
    .slot-btn.AVAILABLE { background: #28a745; color: #fff; }
    .slot-btn.AVAILABLE:hover { background: #218838; }
    .slot-btn.BOOKED { background: #dc3545; color: #fff; cursor: not-allowed; opacity: 0.7; }
    .slot-btn.PAST { background: #6c757d; color: #fff; cursor: not-allowed; opacity: 0.7; }
    .slot-btn.selected { border: 2px solid #000; box-shadow: 0 0 6px #333; }

    /* ‚úÖ Legend styles */
    .legend {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin: 10px 0 20px;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 14px;
      font-weight: bold;
    }
    .legend-item::before {
      content: "";
      display: inline-block;
      width: 14px;
      height: 14px;
      border-radius: 3px;
    }
    .legend-item.available::before { background: #28a745; }
    .legend-item.booked::before { background: #dc3545; }
    .legend-item.past::before { background: #6c757d; }
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="logo-container">
      <div class="earth"></div>
      <h1 class="peach-text">BE PEACE</h1>
    </div>
  </header>

  <h2>üìù Book Your Consultation</h2>

  <p id="timezoneDisplay" style="text-align:center; color:#555; font-size:14px;">
  ‚è∞ Detecting your timezone...
</p>

    <form id="bookingForm">
    <label for="country">Select Your Country:</label>
    <select id="country" required></select>
    <p class="fee" id="feeDisplay">Consultation Fee: --</p>

    <label>Name:</label>
    <input type="text" id="name" required>

    <label>Age:</label>
    <input type="text" id="age" required placeholder="e.g., 1 day, 2 months, 5 years">

    <label>Sex:</label>
    <select id="sex" required>
      <option value="">Select Sex</option>
      <option value="Male">Male ‚ôÇ</option>
      <option value="Female">Female ‚ôÄ</option>
      <option value="Other">Other ‚öß</option>
    </select>

    <label>Phone Number:</label>
    <input id="phone" type="tel" required>

    <label>Email:</label>
    <input type="email" id="email" required>

    <label>Health Concern:</label>
    <textarea id="concern" rows="4" required></textarea>

    <!-- ‚úÖ New Date + Slot selectors -->
    <label for="date">Choose Date:</label>
    <input type="date" id="date" required min="">

    <label for="slot">Choose Time Slot:</label>
    <div id="slotContainer" class="slots-grid"></div>
    <input type="hidden" id="slot" required> <!-- keeps selected slot -->

    <!-- ‚úÖ Legend -->
    <div class="legend">
      <span class="legend-item available">Available</span>
      <span class="legend-item booked">Booked</span>
      <span class="legend-item past">Past</span>
    </div>

    <!-- ‚úÖ Success message -->
    <p id="successMsg" class="success">‚úÖ All good! You can now proceed to payment.</p>

    <!-- Payment button -->
    <button type="button" id="payBtn" disabled>Proceed to Payment</button>
    <a href="index.html" class="back-btn">‚¨Ö Back to Homepage</a>
  </form>

  <!-- Footer -->
  <footer>
    <div class="footer-logo">
      <div class="earth slow"></div>
      <h1 class="peach-text">BE PEACE</h1>
    </div>
    <p>¬© 2025 BE PEACE. All rights reserved.</p>
  </footer>

  <!-- Logic -->
<script>
const payBtn = document.getElementById("payBtn");
const countrySelect = document.getElementById("country");
const feeDisplay = document.getElementById("feeDisplay");
const successMsg = document.getElementById("successMsg");
const dateInput = document.getElementById("date");
const slotInput = document.getElementById("slot");
const slotContainer = document.getElementById("slotContainer");
const phoneInput = document.querySelector("#phone");

let amount = 0, currency = "INR";
const countryToCurrency = {};
let userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
let userOffset = -new Date().getTimezoneOffset() / 60;

function emojiFlag(code) {
  if (!code) return "";
  return code
    .toUpperCase()
    .replace(/./g, char => String.fromCodePoint(127397 + char.charCodeAt()));
}

async function loadCountries() {
  try {
    const res = await fetch("https://restcountries.com/v3.1/all?fields=cca2,name,currencies");
    const countries = await res.json();
    countries.sort((a, b) => a.name.common.localeCompare(b.name.common));

    countries.forEach(c => {
      const opt = document.createElement("option");
      opt.value = c.cca2;
      opt.textContent = `${emojiFlag(c.cca2)} ${c.name.common}`;
      countrySelect.appendChild(opt);
      if (c.currencies) {
        const firstCurrency = Object.keys(c.currencies)[0];
        if (firstCurrency) countryToCurrency[c.cca2] = firstCurrency;
      }
    });
  } catch {
    console.warn("‚ö†Ô∏è Using fallback country list");
    const fallbackCountries = [
      { code: "IN", name: "India", currency: "INR", flag: "üáÆüá≥" },
      { code: "US", name: "United States", currency: "USD", flag: "üá∫üá∏" },
      { code: "GB", name: "United Kingdom", currency: "GBP", flag: "üá¨üáß" },
      { code: "AE", name: "UAE", currency: "AED", flag: "üá¶üá™" },
      { code: "CA", name: "Canada", currency: "CAD", flag: "üá®üá¶" },
      { code: "AU", name: "Australia", currency: "AUD", flag: "üá¶üá∫" }
    ];
    fallbackCountries.forEach(c => {
      const opt = document.createElement("option");
      opt.value = c.code;
      opt.textContent = `${c.flag} ${c.name}`;
      countrySelect.appendChild(opt);
      countryToCurrency[c.code] = c.currency;
    });
  }
}

// üåç Detect user country with fallback
async function detectCountry() {
  try {
    let country = "IN";
    const res1 = await fetch("https://ipapi.co/json");
    const data1 = await res1.json();
    if (data1.country_code && data1.country_code !== "AF") {
      country = data1.country_code;
    } else {
      const res2 = await fetch("https://ipinfo.io/json?token=fa9b9b2fca0c45");
      const data2 = await res2.json();
      if (data2.country) country = data2.country;
    }
    return country;
  } catch {
    return "IN";
  }
}

// üåç Show detected country under select box
function showDetectedCountryInfo(code) {
  let infoBox = document.getElementById("detectedCountryInfo");
  if (!infoBox) {
    infoBox = document.createElement("p");
    infoBox.id = "detectedCountryInfo";
    infoBox.style.fontSize = "14px";
    infoBox.style.color = "#555";
    infoBox.style.fontWeight = "bold";
    infoBox.style.marginTop = "-10px";
    countrySelect.insertAdjacentElement("afterend", infoBox);
  }
  infoBox.textContent = `üåç Detected: ${emojiFlag(code)} ${countrySelect.options[countrySelect.selectedIndex].text}`;
}

// üåç Initialize countries + detect
async function initCountries() {
  await loadCountries();
  const detected = await detectCountry();
  countrySelect.value = detected;
  iti.setCountry(detected);
  setFee(detected);
  showDetectedCountryInfo(detected);
}

// ‚úÖ Currency symbols map for better display
const currencySymbols = {
  INR: "‚Çπ",
  USD: "$",
  GBP: "¬£",
  EUR: "‚Ç¨",
  AED: "ÿØ.ÿ•",
  CAD: "CA$",
  AUD: "A$",
  SGD: "S$",
  JPY: "¬•",
  CNY: "¬•",
  BRL: "R$",
  ZAR: "R",
};

let exchangeRates = {};
let exchangeRatesLoaded = false;

// ‚úÖ Load exchange rates (with cache for 24 hours)
async function loadRates() {
  try {
    const cached = localStorage.getItem("exchangeRatesData");
    const cachedTime = localStorage.getItem("exchangeRatesTime");
    const now = Date.now();

    // Use cache if less than 24h old
    if (cached && cachedTime && now - cachedTime < 24 * 60 * 60 * 1000) {
      exchangeRates = JSON.parse(cached);
      exchangeRatesLoaded = true;
      console.log("üí∞ Using cached exchange rates");
      return;
    }

   const res = await fetch("https://open.er-api.com/v6/latest/USD");
    const data = await res.json();
    data.rates = data.rates || data.result?.rates || {};

    if (data && data.rates) {
      exchangeRates = data.rates;
      localStorage.setItem("exchangeRatesData", JSON.stringify(exchangeRates));
      localStorage.setItem("exchangeRatesTime", now.toString());
      exchangeRatesLoaded = true;
      console.log("‚úÖ Exchange rates loaded:", Object.keys(exchangeRates).length);
    } else {
      console.warn("‚ö†Ô∏è No exchange rate data found");
    }
  } catch (err) {
    console.warn("‚ùå Exchange rate fetch failed:", err);
  }
}

loadRates();

// ‚úÖ Update consultation fee dynamically
function setFee(countryCode) {
  if (countryCode === "IN") {
    amount = 10;
    currency = "INR";
    const symbol = currencySymbols["INR"] || "‚Çπ";
    feeDisplay.textContent = `Consultation Fee: ${symbol}${amount} INR`;
  } else {
    amount = 40;
    currency = "USD";
    const symbol = currencySymbols["USD"] || "$";
    feeDisplay.textContent = `Consultation Fee: ${symbol}${amount} USD`;

    const localCurrency = countryToCurrency[countryCode] || "USD";
    if (localCurrency !== "USD" && exchangeRates[localCurrency]) {
      const converted = (amount * exchangeRates[localCurrency]).toFixed(2);
      const localSymbol = currencySymbols[localCurrency] || localCurrency;
      feeDisplay.textContent += ` (~${localSymbol}${converted} ${localCurrency})`;
    } else if (!exchangeRatesLoaded) {
      // if rates not ready yet, retry in 2 seconds
      setTimeout(() => setFee(countryCode), 2000);
    }
  }
}

// üìû intl-tel-input setup
const iti = window.intlTelInput(phoneInput, {
  initialCountry: "auto",
  geoIpLookup: cb => fetch("https://ipapi.co/json")
    .then(res => res.json())
    .then(data => cb(data.country_code))
    .catch(() => cb("IN")),
  utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.19/js/utils.js"
});

countrySelect.addEventListener("change", () => {
  const selected = countrySelect.value;
  iti.setCountry(selected);
  setFee(selected);
  showDetectedCountryInfo(selected);

  // üîÑ Refresh slots so times convert to correct local timezone
  if (dateInput.value) {
    loadSlots(dateInput.value);
  }

  // üïí Optional: show user‚Äôs timezone for clarity
  const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
  console.log("User Timezone:", tz);
});

initCountries();

window.addEventListener("DOMContentLoaded", async () => {
  const timezoneDisplay = document.getElementById("timezoneDisplay");
  const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
  const offsetHours = -new Date().getTimezoneOffset() / 60;
  timezoneDisplay.textContent = `‚è∞ Your timezone: ${tz.replace("_", " ")} (UTC ${offsetHours >= 0 ? "+" : ""}${offsetHours})`;
  console.log("‚úÖ Timezone detected:", tz, "Offset:", offsetHours);

  await initCountries();
  loadSlots(todayISO);
});

// ‚úÖ Block past dates + preselect today
const todayISO = new Date().toISOString().split("T")[0];
dateInput.setAttribute("min", todayISO);
dateInput.value = todayISO;

 // üîπ Convert IST slot ‚Üí User‚Äôs Local Time
  function convertToLocalTime(slotTime, date) {
    const [timeStr, meridian] = slotTime.split(" ");
    let [hour, minute] = timeStr.split(":").map(Number);
    if (meridian === "PM" && hour !== 12) hour += 12;
    if (meridian === "AM" && hour === 12) hour = 0;

    const [yyyy, mm, dd] = date.split("-");
    const localDateTime = new Date(yyyy, mm - 1, dd, hour, minute);

    // Create IST date in UTC (by subtracting 5h30m offset)
  const utcMillis = Date.UTC(yyyy, mm - 1, dd, hour - 5, minute - 30);
  const utcDate = new Date(utcMillis);

  // Convert to user‚Äôs local browser time
  return utcDate.toLocaleTimeString([], {
    hour: "2-digit",
    minute: "2-digit",
    hour12: true,
  });
}

// ‚úÖ Convert Local (User‚Äôs) Time ‚Üí IST (for backend consistency)
function convertToIST(localDate, localTimeStr) {
  const [timeStr, meridian] = localTimeStr.split(" ");
  let [hour, minute] = timeStr.split(":").map(Number);
  if (meridian === "PM" && hour !== 12) hour += 12;
  if (meridian === "AM" && hour === 12) hour = 0;

  const [yyyy, mm, dd] = localDate.split("-");
  const localDateTime = new Date(yyyy, mm - 1, dd, hour, minute);

  // Convert from local browser time to IST
  const istOffset = 5.5 * 60; // minutes
  const localOffset = localDateTime.getTimezoneOffset(); // in minutes
  const diff = (istOffset + localOffset) * 60 * 1000; // milliseconds

  const istDateTime = new Date(localDateTime.getTime() + diff);

  const istHour = istDateTime.getHours();
  const istMinute = istDateTime.getMinutes().toString().padStart(2, "0");
  const suffix = istHour >= 12 ? "PM" : "AM";
  const hour12 = (istHour % 12) || 12;
  return `${hour12}:${istMinute} ${suffix}`;
}

// ‚úÖ Function to load slots (show user‚Äôs local timezone)
async function loadSlots(date) {
  slotContainer.innerHTML = "‚è≥ Loading slots...";
  slotInput.value = "";
  if (!date) return;

  try {
    const res = await fetch(`/api/get-slots?date=${date}`);
    const data = await res.json();
    slotContainer.innerHTML = "";

    if (data.slots && data.slots.length > 0) {
      data.slots.forEach(slot => {
        const btn = document.createElement("button");

        // Fallback if slot.utc_time missing
      let localTime;
      if (slot.utc_time) {
      localTime = new Date(slot.utc_time).toLocaleTimeString([], {
      hour: "2-digit",
      minute: "2-digit",
    hour12: true,
  });
} else {
  localTime = convertToLocalTime(slot.time, date);
}

        btn.textContent = `${localTime} (Your Time)`;
        btn.type = "button";
        btn.className = `slot-btn ${slot.status}`;

        if (slot.status === "AVAILABLE") {
          btn.addEventListener("click", () => {
            document.querySelectorAll(".slot-btn.AVAILABLE").forEach(b => b.classList.remove("selected"));
            btn.classList.add("selected");

            // ‚úÖ Store IST time internally for backend consistency
            slotInput.value = slot.time; 
            validateForm();
          });
        } else {
          btn.disabled = true;
        }

        slotContainer.appendChild(btn);
      });
    } else {
      slotContainer.innerHTML = "<p>No slots available</p>";
    }
  } catch (err) {
    console.error("Slot load error:", err);
    slotContainer.innerHTML = "<p>‚ùå Error loading slots</p>";
  }

  validateForm();
}

// ‚úÖ Also reload when user changes date
dateInput.addEventListener("change", () => loadSlots(dateInput.value));

  // ‚úÖ Validation
  function validateForm() {
    const name = document.getElementById("name").value.trim();
    const age = document.getElementById("age").value.trim();
    const sex = document.getElementById("sex").value;
    const phone = iti.getNumber(); // full intl format, e.g. +91xxxx or +1xxxx
    const email = document.getElementById("email").value.trim();
    const concern = document.getElementById("concern").value.trim();
    const country = countrySelect.value;
    const date = dateInput.value;
    const slot = slotInput.value;

    let valid = true;
    if (!name || !age || !sex || !phone || !email || !concern || !country || !date || !slot) {
      valid = false;
    }

    if (valid) {
      payBtn.disabled = false;
      payBtn.classList.add("active");
      successMsg.style.display = "block";
    } else {
      payBtn.disabled = true;
      payBtn.classList.remove("active");
      successMsg.style.display = "none";
    }
    return valid;
  }


 // ‚úÖ Watch fields
  ["name","age","sex","phone","email","concern","country","date","slot"].forEach(id=>{
    document.getElementById(id).addEventListener("input", validateForm);
    document.getElementById(id).addEventListener("change", validateForm);
  });

  // ‚úÖ Payment trigger with Cashfree v3 Checkout
  payBtn.addEventListener("click", function () {
    if (!validateForm()) return;

  const name = document.getElementById("name").value;
  const email = document.getElementById("email").value;
  const phone = iti.getNumber(); // full intl format
  const age = document.getElementById("age").value;
  const sex = document.getElementById("sex").value;
  const date = document.getElementById("date").value;


  // ‚úÖ Convert selected local slot to IST before sending
  const slot = convertToIST(date, document.getElementById("slot").value);


    const userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
    const userOffset = -new Date().getTimezoneOffset() / 60;

fetch("/api/create-order", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    amount, currency,
    customer_name: name,
    customer_email: email,
    customer_phone: phone,
    customer_age: age,
    customer_sex: sex,
    date,
    slot,
    user_timezone: userTimezone,
    user_utc_offset: userOffset
  })
})
    .then(res => res.json())
    .then(data => {
      if (data.payment_session_id) {
        const cashfree = new Cashfree({ mode: "production" }); // ‚úÖ LIVE only
        cashfree.checkout({
          paymentSessionId: data.payment_session_id,
          redirectTarget: "_self"
        });
      } else {
        alert("‚ùå Error creating payment session.");
      }
    })
    .catch(() => alert("Server error. Please try again later."));
  });
</script>
</body>
</html>