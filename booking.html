<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Book Consultation - BE PEACE</title>

  <!-- SEO -->
  <meta name="description" content="Book an online pediatric or general health consultation with BE PEACE. Simple, fast, and trusted video consultations." />
  <meta property="og:title" content="Book a Consultation ‚Äì BE PEACE" />
  <meta property="og:description" content="Schedule your online health consultation with BE PEACE today. Trusted by families worldwide." />
  <meta property="og:url" content="https://bepeace.in/booking.html" />
  <meta property="og:image" content="https://bepeace.in/images/doctor.jpg" />
  <meta name="twitter:card" content="summary_large_image" />

  <link rel="stylesheet" href="/style.css" />
  <script src="https://sdk.cashfree.com/js/v3/cashfree.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.19/css/intlTelInput.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.19/js/intlTelInput.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; background: #fff; margin: 0; padding: 0; }
    h2 { text-align: center; color: #c71585; margin: 25px 0; }
    form { background: #fff; padding: 25px; border-radius: 10px; max-width: 650px; margin: auto; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    label { font-weight: bold; display: block; margin: 10px 0 5px; }
    input, select, textarea { width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 5px; border: 1px solid #ccc; font-size: 1rem; height: 44px; box-sizing: border-box; }
    textarea { min-height: 100px; }
    button { background: #ccc; color: white; padding: 12px; border: none; border-radius: 5px; font-size: 16px; width: 100%; cursor: not-allowed; transition: all 0.3s; box-shadow: 0 4px 10px rgba(0,0,0,0.15); }
    button.active { background: #28a745; cursor: pointer; }
    button.active:hover { box-shadow: 0 6px 15px rgba(40,167,69,0.6); transform: translateY(-2px); }
    .slots-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; margin: 10px 0 20px; }
    .slot-btn { padding: 10px; border-radius: 6px; font-size: 14px; border: none; cursor: pointer; font-weight: bold; transition: all 0.3s; }
    .slot-btn.available { background: #28a745; color: #fff; }
    .slot-btn.booked { background: #dc3545; color: #fff; cursor: not-allowed; opacity: 0.7; }
    .slot-btn.past { background: #6c757d; color: #fff; cursor: not-allowed; opacity: 0.7; }
    .slot-btn.selected { background: #007bff; color: #fff; border: 2px solid #0056b3; box-shadow: 0 0 6px rgba(0,123,255,0.6); }
    .legend { display: flex; justify-content: center; gap: 15px; margin: 10px 0 20px; }
    .legend-item { display: flex; align-items: center; gap: 5px; font-size: 14px; font-weight: bold; }
    .legend-item::before { content: ""; width: 14px; height: 14px; border-radius: 3px; }
    .legend-item.available::before { background: #28a745; }
    .legend-item.booked::before { background: #dc3545; }
    .legend-item.past::before { background: #6c757d; }
  </style>
</head>

<body>
  <header>
    <div class="logo-container">
      <div class="earth"></div>
      <h1 class="peach-text">BE PEACE</h1>
    </div>
  </header>

  <h2>üìù Book Your Consultation</h2>
  <p id="timezoneDisplay" style="text-align:center; color:#555; font-size:14px;">‚è∞ Detecting your timezone...</p>

  <form id="bookingForm">
    <label for="country">Select Your Country:</label>
    <select id="country" required></select>
    <p class="fee" id="feeDisplay">Consultation Fee: --</p>

    <label>Name:</label><input type="text" id="name" required />
    <label>Age:</label><input type="text" id="age" required placeholder="e.g., 5 years" />
    <label>Sex:</label>
    <select id="sex" required>
      <option value="">Select Sex</option>
      <option value="Male">Male ‚ôÇ</option>
      <option value="Female">Female ‚ôÄ</option>
      <option value="Other">Other ‚öß</option>
    </select>
    <label>Phone:</label><input id="phone" type="tel" required />
    <label>Email:</label><input type="email" id="email" required />
    <label>Health Concern:</label><textarea id="concern" required></textarea>

    <label>Choose Date:</label>
    <input type="date" id="date" required />
    <label>Choose Time Slot:</label>
    <div id="slotContainer" class="slots-grid"></div>
    <input type="hidden" id="slot" required />

    <div class="legend">
      <span class="legend-item available">Available</span>
      <span class="legend-item booked">Booked</span>
      <span class="legend-item past">Past</span>
    </div>

    <p id="successMsg" class="success" style="display:none;color:green;font-weight:bold;">‚úÖ All good! Proceed to payment.</p>
    <button type="button" id="payBtn" disabled>Proceed to Payment</button>
    <a href="index.html" class="back-btn" style="text-align:center;display:block;margin-top:12px;">‚¨Ö Back to Homepage</a>
  </form>

  <footer>
    <div class="footer-logo">
      <div class="earth slow"></div>
      <h1 class="peach-text">BE PEACE</h1>
    </div>
    <p>¬© 2025 BE PEACE. All rights reserved.</p>
  </footer>

  <script>
    const payBtn = document.getElementById("payBtn");
    const countrySelect = document.getElementById("country");
    const dateInput = document.getElementById("date");
    const slotContainer = document.getElementById("slotContainer");
    const slotInput = document.getElementById("slot");
    const feeDisplay = document.getElementById("feeDisplay");
    const successMsg = document.getElementById("successMsg");
    const phoneInput = document.querySelector("#phone");

    let amount = 0, currency = "INR";
    const todayISO = new Date().toISOString().split("T")[0];
    dateInput.setAttribute("min", todayISO);
    dateInput.value = todayISO;

    const currencySymbols = { INR: "‚Çπ", USD: "$", GBP: "¬£", EUR: "‚Ç¨", AED: "ÿØ.ÿ•", CAD: "CA$", AUD: "A$", SGD: "S$", JPY: "¬•", CNY: "¬•" };
    const countryToCurrency = { IN: "INR", US: "USD", GB: "GBP", AE: "AED", CA: "CAD", AU: "AUD" };

    // üìû intl-tel-input
    const iti = window.intlTelInput(phoneInput, {
      initialCountry: "auto",
      geoIpLookup: cb => fetch("https://ipapi.co/json").then(res => res.json()).then(d => cb(d.country_code)).catch(() => cb("IN")),
      utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.19/js/utils.js"
    });

    // üí± Exchange Rates (cache 24h)
    let exchangeRates = {};
    async function loadRates() {
      try {
        const cache = localStorage.getItem("exchangeRatesData");
        const cacheTime = localStorage.getItem("exchangeRatesTime");
        const now = Date.now();
        if (cache && cacheTime && now - cacheTime < 24*60*60*1000) {
          exchangeRates = JSON.parse(cache);
          return;
        }
        const res = await fetch("https://open.er-api.com/v6/latest/USD");
        const data = await res.json();
        exchangeRates = data.rates || {};
        localStorage.setItem("exchangeRatesData", JSON.stringify(exchangeRates));
        localStorage.setItem("exchangeRatesTime", now);
      } catch (err) { console.warn("Exchange rate fetch failed:", err); }
    }

    // üåç Set Fee
    function setFee(code) {
      if (code === "IN") {
        amount = 10; currency = "INR"; feeDisplay.textContent = `Consultation Fee: ‚Çπ10 INR`;
      } else {
        amount = 40; currency = "USD";
        const localCur = countryToCurrency[code] || "USD";
        const base = `$${amount} USD`;
        if (exchangeRates[localCur]) {
          const converted = (amount * exchangeRates[localCur]).toFixed(2);
          const localSymbol = currencySymbols[localCur] || localCur;
          feeDisplay.textContent = `Consultation Fee: ${base} (~${localSymbol}${converted} ${localCur})`;
        } else feeDisplay.textContent = `Consultation Fee: ${base}`;
      }
    }

    async function loadCountries() {
      const res = await fetch("https://restcountries.com/v3.1/all?fields=cca2,name");
      const countries = await res.json();
      countries.sort((a,b)=>a.name.common.localeCompare(b.name.common));
      countries.forEach(c=>{
        const opt=document.createElement("option");
        opt.value=c.cca2; opt.textContent=c.name.common;
        countrySelect.appendChild(opt);
      });
    }

    window.addEventListener("DOMContentLoaded", async()=>{
      await loadCountries(); await loadRates();
      const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
      document.getElementById("timezoneDisplay").textContent = `‚è∞ Your timezone: ${tz}`;
      countrySelect.value = "IN"; iti.setCountry("IN"); setFee("IN");
      loadSlots(todayISO);
    });

    countrySelect.addEventListener("change", ()=>setFee(countrySelect.value));

    // ‚úÖ Slots (cache 24h)
    async function loadSlots(date) {
      slotContainer.innerHTML = "‚è≥ Loading slots...";
      const cacheKey=`slots_${date}`, cacheTimeKey=`${cacheKey}_time`, now=Date.now();
      const cached=localStorage.getItem(cacheKey), cacheTime=localStorage.getItem(cacheTimeKey);
      if(cached && cacheTime && now-cacheTime<24*60*60*1000){
        renderSlots(JSON.parse(cached)); return;
      }
      try{
        const res=await fetch(`/api/doctor?path=slots&date=${date}`);
        const data=await res.json();
        if(!data.success||!data.slots?.length){slotContainer.innerHTML="<p>No slots available</p>";return;}
        localStorage.setItem(cacheKey,JSON.stringify(data.slots));localStorage.setItem(cacheTimeKey,now);
        renderSlots(data.slots);
      }catch(e){slotContainer.innerHTML="<p>‚ùå Error loading slots</p>";}
    }

    function renderSlots(slots){
      slotContainer.innerHTML="";
      slots.forEach(s=>{
        const btn=document.createElement("button");
        btn.textContent=s.slot;btn.type="button";
        btn.className=`slot-btn ${s.status.toLowerCase()}`;
        if(s.status==="available"){
          btn.onclick=()=>{document.querySelectorAll(".slot-btn.available").forEach(b=>b.classList.remove("selected"));
          btn.classList.add("selected");slotInput.value=s.slot;validateForm();};
        }else btn.disabled=true;
        slotContainer.appendChild(btn);
      });
      validateForm();
    }

    function validateForm(){
      const valid=["name","age","sex","phone","email","concern","date","slot"].every(id=>document.getElementById(id).value.trim());
      if(valid){payBtn.disabled=false;payBtn.classList.add("active");successMsg.style.display="block";}
      else{payBtn.disabled=true;payBtn.classList.remove("active");successMsg.style.display="none";}
      return valid;
    }
    ["name","age","sex","phone","email","concern","date","slot"].forEach(id=>{
      document.getElementById(id).addEventListener("input",validateForm);
      document.getElementById(id).addEventListener("change",validateForm);
    });

    payBtn.addEventListener("click", async()=>{
      if(!validateForm())return;
      const name=name.value.trim(),email=email.value.trim(),phone=iti.getNumber(),
            age=document.getElementById("age").value.trim(),sex=document.getElementById("sex").value,
            concern=document.getElementById("concern").value.trim(),date=document.getElementById("date").value,
            slot=document.getElementById("slot").value;
      try{
        const res=await fetch("/api/payment?path=create",{method:"POST",headers:{"Content-Type":"application/json"},
        body:JSON.stringify({name,email,phone,amount,currency,date,slot,age,sex,concern})});
        const data=await res.json();
        if(!data.success)return alert("‚ùå Payment creation failed.");
        const cashfree=new Cashfree({mode:"production"});
        cashfree.checkout({paymentSessionId:data.payment_session_id,redirectTarget:"_self"});
      }catch(err){alert("‚ö†Ô∏è Server error.");console.error(err);}
    });
  </script>
</body>
</html>