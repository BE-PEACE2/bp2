import { auth, database } from "./firebase-init.js";
import {
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
import {
  ref,
  onValue
} from "https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js";

const greeting = document.getElementById("greeting");
const upcomingList = document.getElementById("upcomingList");
const pastList = document.getElementById("pastList");
const allList = document.getElementById("allList");
const loading = document.getElementById("loading");

const profileName = document.getElementById("profileName");
const profileEmail = document.getElementById("profileEmail");
const profileAvatar = document.getElementById("profileAvatar");
const totalConsultations = document.getElementById("totalConsultations");
const upcomingStatus = document.getElementById("upcomingStatus");

function loadBookings(email) {
  const bookingsRef = ref(database, "bookings");
  onValue(bookingsRef, (snapshot) => {
    if (!snapshot.exists()) {
      loading.textContent = "No consultations yet.";
      return;
    }

    const allBookings = snapshot.val();
    const userBookings = Object.values(allBookings).filter(
      (b) => b.email && b.email.toLowerCase() === email.toLowerCase()
    );

    if (!userBookings.length) {
      loading.textContent = "No consultations found.";
      totalConsultations.textContent = "0";
      upcomingStatus.textContent = "None";
      return;
    }

    const now = new Date();
    const upcoming = [];
    const past = [];

    userBookings.forEach((b) => {
      const dt = new Date(b.date);
      if (dt >= now) upcoming.push(b);
      else past.push(b);
    });

    totalConsultations.textContent = userBookings.length;
    upcomingStatus.textContent = upcoming.length
      ? `${upcoming[0].date} â€¢ ${upcoming[0].slot}`
      : "None";

    loading.style.display = "none";
    renderList(upcomingList, upcoming, true);
    renderList(pastList, past, false);
    renderList(allList, userBookings, false);
  });
}

function renderList(container, list, isUpcoming) {
  container.innerHTML = "";
  if (!list.length) {
    container.innerHTML = `<div class='small-muted'>No consultations yet.</div>`;
    return;
  }

  list.forEach((b) => {
    const div = document.createElement("div");
    div.className = "appointment";

    const joinButton =
      isUpcoming && b.order_id
        ? `<button class="join-btn" onclick="window.open('https://meet.bepeace.in/bepeace-${b.order_id}','_blank')">Join</button>`
        : "";
    const prescriptionButton = b.prescriptionUrl
      ? `<button class="join-btn" onclick="window.open('${b.prescriptionUrl}','_blank')">Prescription</button>`
      : "";
    const receiptButton = b.receiptUrl
      ? `<button class="join-btn" onclick="window.open('${b.receiptUrl}','_blank')">Receipt</button>`
      : "";

    div.innerHTML = `
      <div style="display:flex;align-items:center;gap:12px">
        <div class="avatar">${(b.name || "P")[0].toUpperCase()}</div>
        <div>
          <div style="font-weight:700">${b.name || b.email}</div>
          <div class="small-muted">
            ${b.date} â€¢ ${b.slot || "N/A"}<br>
            Status: <b style="color:${
              b.status === "confirmed" ? "green" : "gray"
            }">${b.status}</b>
          </div>
        </div>
      </div>
      <div style="display:flex;flex-direction:column;gap:6px;">
        ${joinButton}
        ${prescriptionButton}
        ${receiptButton}
      </div>
    `;
    container.append(div);
  });
}

onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "/login.html";
    return;
  }

  const name = user.displayName || user.email.split("@")[0];
  greeting.textContent = `Hello ${name} ðŸ‘‹`;
  profileName.textContent = name;
  profileEmail.textContent = user.email;
  profileAvatar.textContent = name[0].toUpperCase();
  loadBookings(user.email);
});

document.addEventListener("click", async (e) => {
  if (e.target && e.target.id === "logoutBtn") {
    await signOut(auth);
    window.location.href = "/login.html";
  }
});