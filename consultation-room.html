<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>BE PEACE | Consultation Room</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="/style.css" />
  <style>
/* ===== BE PEACE CALM BACKGROUND ===== */
body {
  background: radial-gradient(circle at center, #ffeaf3 0%, #f8b6d0 55%, #ffffff 100%);
  animation: calmBreathe 10s ease-in-out infinite alternate;
  transition: background 1s ease-in-out;
  margin: 0;
  font-family: 'Inter', Arial, sans-serif;
}

@keyframes calmBreathe {
  0% {
    background: radial-gradient(circle at center, #fff7fa 0%, #fde3ef 50%, #ffffff 100%);
  }
  100% {
    background: radial-gradient(circle at center, #ffffff 0%, #fbe7f1 65%, #fff 100%);
  }
}

/* ===== MAIN LAYOUT ===== */
main { width:100%; height:calc(100vh - 120px); display:flex; justify-content:center; align-items:center; margin:0; padding:0; }
#meet {
  width:95%; height:85vh; border-radius:16px; overflow:hidden; background:#000; position:relative;
  transform:translate(40px,15px); transition:0.4s ease; box-shadow:0 0 60px 10px rgba(255,160,180,0.18);
  animation:calmGlow 6s ease-in-out infinite alternate;
}
@keyframes calmGlow {
  0% { box-shadow: 0 0 50px 8px rgba(255,170,185,0.18); }
  100% { box-shadow: 0 0 80px 16px rgba(255,145,165,0.28); }
}
#meet iframe { width:100%!important; height:100%!important; border:none; border-radius:16px; object-fit:cover; }
#meet .ended-msg { color:#fff; padding:20px; text-align:center; font-size:1.1rem; }

/* mobile */
@media(max-width:768px){
  #meet { width:100%; height:70vh; transform:translate(0,10px); border-radius:10px; }
}
</style>
</head>

<body>
<div id="header"></div>

<main>
  <div style="width:100%;">
    <div id="meet">Loading consultation room...</div>
  </div>
</main>

<div id="footer"></div>

<script src="https://meet.bepeace.in/external_api.js"></script>
<script src="/js/load-partials.js"></script>

<script type="module">
/* ---------------------------------------------------
    GLOBALS + CLEANUP
--------------------------------------------------- */
console.log("üîµ consultation-room loaded");

let jitsiApi = null;
let alreadyRedirected = false;
let safeOnDisconnectRef = null; // hold onDisconnect handler reference

window.onbeforeunload = async () => {
  console.log("üßπ Cleaning Jitsi instance (beforeunload)‚Ä¶");
  // If doctor and jitsiApi exists, try to mark meeting ended quickly (best-effort)
  try {
    if (jitsiApi) {
      try { jitsiApi.dispose(); } catch(e){}
      jitsiApi = null;
    }
  } catch(e){
    console.warn("üß® Error while disposing jitsi:", e);
  }
};

/* ---------------------------------------------------
    FIREBASE INIT
--------------------------------------------------- */
import { auth, database } from "/js/firebase-init.js";
import { ref, get, set, update, onValue, onDisconnect, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const params = new URLSearchParams(window.location.search);
const roomName = params.get("room");
const role = (params.get("role") || "patient").toLowerCase();
const urlPatientName = params.get("patientName") || "";
let displayName = "Guest";

console.log("üü£ Room:", roomName);
console.log("üü£ Role:", role);

if (!roomName) {
  console.log("‚ùå No room, redirecting‚Ä¶");
  window.location.replace(role === "doctor" ? "/doctor-dashboard.html" : "/dashboard.html");
}

/* ---------------------------------------------------
    HELPERS
--------------------------------------------------- */
function toTitleCase(str){
  return str ? str.toLowerCase().split(" ").map(w=>w[0].toUpperCase()+w.slice(1)).join(" ") : "";
}

async function getPatientName(orderId){
  try{
    const snap = await get(ref(database,"bookings/"+orderId));
    return snap.exists() ? toTitleCase(snap.val().name) : "Guest Patient";
  } catch(e){
    return "Guest Patient";
  }
}

/* ---------------------------------------------------
    AUTH LISTENER
--------------------------------------------------- */
auth.onAuthStateChanged(async (user)=>{
  console.log("üü¢ Firebase auth state:", user?.uid);

  if(role === "doctor" && user){
    try{
      const usr = (await get(ref(database,"users/"+user.uid))).val();
      displayName = usr?.name ? "Dr "+toTitleCase(usr.name) : "Dr "+toTitleCase((usr.email||"").split("@")[0]);
    }catch(e){ displayName="Dr Anonymous"; }
  } 
  else if(role === "patient"){
    displayName = urlPatientName.trim()
      ? toTitleCase(urlPatientName)
      : await getPatientName(roomName);
  }

  console.log("üü¢ Final displayName:", displayName);

  initJitsi(displayName);
  attachMeetingSync();
});

/* ---------------------------------------------------
    INIT JITSI
--------------------------------------------------- */
function initJitsi(displayName){
  console.log("üîµ initJitsi");

  if(jitsiApi){
    console.log("‚ö†Ô∏è Jitsi already initialized ‚Äî skipping re-init");
    return;
  }

  document.querySelector("#meet").innerHTML = "";

  const domain = "meet.bepeace.in";
  const defaultButtons = ["microphone","camera","desktop","fullscreen","chat","raisehand","tileview"];
  const toolbarButtons = role==="doctor" ? [...defaultButtons,"hangup"] : defaultButtons;

  const options = {
    roomName,
    parentNode: document.querySelector("#meet"),
    userInfo: { displayName },
    width: "100%",
    height: "100%",
    lang: "en",

    configOverwrite: {
      prejoinPageEnabled: false,
      disableDeepLinking: true,
      startWithAudioMuted: false,
      startWithVideoMuted: false
    },

    interfaceConfigOverwrite: {
      SHOW_JITSI_WATERMARK: false,
      SHOW_POWERED_BY: false,
      TOOLBAR_BUTTONS: toolbarButtons,
      ENABLE_CLOSE_PAGE: false
    }
  };

  try {
    jitsiApi = new JitsiMeetExternalAPI(domain, options);
  } catch(e){
    console.error("üî• Failed to initialize JitsiMeetExternalAPI:", e);
    document.querySelector("#meet").innerHTML = "<div class='ended-msg'>Unable to start meeting. Please refresh or contact support.</div>";
    return;
  }

  const api = jitsiApi; // local alias for readability

  /* ---------------------------
      JOINED EVENT
  ---------------------------- */
  api.addEventListener("videoConferenceJoined", async () => {
    console.log("üü¢ JITSI ‚Äî videoConferenceJoined (role:", role, ")");

    try {
      const meetRef = ref(database, "meetings/" + roomName);
      const snap = await get(meetRef);
      const current = snap.exists() ? snap.val() : {};

      if (role === "doctor") {
        console.log("ü©∫ Doctor joined ‚Üí mark meeting ongoing (set + register onDisconnect)");

        // Mark meeting ongoing right away
        await set(meetRef, {
          status: "ongoing",
          doctorJoined: true,
          patientJoined: current.patientJoined || false,
          startedAt: new Date().toISOString(),
          endedAt: null
        });

        // Register an onDisconnect safety so if doctor loses connection or closes tab unexpectedly,
        // Firebase will mark the meeting ended (best-effort, serverTimestamp used).
        try {
          const odRef = ref(database, "meetings/" + roomName);
          const od = onDisconnect(odRef);
          // Use update with serverTimestamp for endedAt
          od.update({
            status: "ended",
            doctorJoined: false,
            patientJoined: false,
            endedAt: serverTimestamp()
          });
          safeOnDisconnectRef = od; // store to optionally cancel later
          console.log("‚úÖ onDisconnect registered for doctor (safety).");
        } catch (odErr) {
          console.warn("‚ö†Ô∏è Could not register onDisconnect:", odErr);
        }
      }

      if (role === "patient") {
        console.log("üë∂ Patient joined ‚Üí mark patientJoined");

        // If patientJoined not recorded, update it once
        if (!current.patientJoined) {
          await update(meetRef, { patientJoined: true });
          console.log("‚úÖ patientJoined updated");
        } else {
          console.log("‚ö†Ô∏è patientJoined already true ‚Üí NO DB update");
        }
      }
    } catch (e) {
      console.error("üî• Firebase update error on videoConferenceJoined:", e);
    }
  });

  /* ---------------------------
      PARTICIPANT LEFT - doctor-side triggers meeting end
      (participantLeft fires for any participant leaving; we only
       perform full meeting-end actions when this instance is doctor)
  ---------------------------- */
  api.addEventListener("participantLeft", async (event) => {
    console.log("üî¥ participantLeft fired:", event);

    // This handler can detect when other participants leave; only the doctor's page should treat it as meeting end.
    if (role !== "doctor") {
      console.log("‚≠ï This is not doctor instance ‚Äî ignoring participantLeft for meeting end.");
      return;
    }

    // If doctor left (meaning another participant left while doctor is present) we don't necessarily end meeting.
    // We only treat doctor's own leave via 'videoConferenceLeft' or hangup. participantLeft here is kept as an info log.
    console.log("‚ÑπÔ∏è Doctor instance detected participantLeft (no automatic meeting end from this event).");
  });

  /* ---------------------------
      HANGUP / VIDEO LEFT - doctor explicitly ends meeting
  ---------------------------- */
  api.addEventListener("hangup", async () => {
    console.log("ü©∫ hangup event fired");

    // Hangup may be clicked by doctor or patient. Only doctor should end meeting and redirect to doctor dashboard.
    if (role === "doctor") {
      console.log("ü©∫ Doctor clicked hangup ‚Äî ending meeting now");
      try {
        await update(ref(database, "meetings/" + roomName), {
          status: "ended",
          doctorJoined: false,
          patientJoined: false,
          endedAt: new Date().toISOString()
        });
        // Cancel onDisconnect (best-effort) because we ended gracefully
        try { if (safeOnDisconnectRef && typeof safeOnDisconnectRef.cancel === 'function') safeOnDisconnectRef.cancel(); } catch(e){}
      } catch (e) {
        console.error("üî• Error marking meeting ended on hangup:", e);
      } finally {
        // Give a tiny moment then navigate
        setTimeout(()=> {
          try { api.dispose(); } catch(e){}
          jitsiApi = null;
          window.location.replace("/doctor-dashboard.html");
        }, 150);
      }
    } else {
      console.log("‚≠ï hangup by patient - just disconnect locally");
      try {
        api.executeCommand && api.executeCommand("hangup");
      } catch(e){}
    }
  });

  /* ---------------------------
      videoConferenceLeft - fired when current participant leaves
      We'll use this to mark meeting ended if the doctor explicitly leaves/close
  ---------------------------- */
  api.addEventListener("videoConferenceLeft", async () => {
    console.log("üî¥ JITSI ‚Äî videoConferenceLeft (role:", role, ")");

    if (role === "doctor") {
      if (alreadyRedirected) {
        console.log("‚ö†Ô∏è Already redirected/ended ‚Äî skipping videoConferenceLeft handler");
        return;
      }
      alreadyRedirected = true;
      console.log("ü©∫ Doctor left via videoConferenceLeft ‚Äî ending meeting");

      try{
        await update(ref(database, "meetings/" + roomName), {
          status: "ended",
          doctorJoined: false,
          patientJoined: false,
          endedAt: new Date().toISOString()
        });
        try { if (safeOnDisconnectRef && typeof safeOnDisconnectRef.cancel === 'function') safeOnDisconnectRef.cancel(); } catch(e){}
      }catch(e){
        console.error("üî• Firebase error on videoConferenceLeft:", e);
      } finally {
        try { api.dispose(); } catch(e){}
        jitsiApi = null;
        window.location.replace("/doctor-dashboard.html");
      }
    } else {
      console.log("üë∂ Patient left the meeting (videoConferenceLeft) ‚Äî just local disconnect.");
      try { api.dispose(); } catch(e){}
      jitsiApi = null;
      // Optionally redirect patient to dashboard after small delay
      setTimeout(()=> {
        if (!alreadyRedirected) {
          alreadyRedirected = true;
          window.location.replace("/dashboard.html");
        }
      }, 200);
    }
  });

  /* ---------------------------
      Ensure doctor's unload also marks meeting ended (best-effort)
  ---------------------------- */
  if (role === "doctor") {
    window.addEventListener("pagehide", async () => {
      console.log("üü† pagehide fired (doctor) ‚Äî attempting graceful end");
      if (alreadyRedirected) return;
      alreadyRedirected = true;
      try{
        await update(ref(database, "meetings/" + roomName), {
          status: "ended",
          doctorJoined: false,
          patientJoined: false,
          endedAt: new Date().toISOString()
        });
        try { if (safeOnDisconnectRef && typeof safeOnDisconnectRef.cancel === 'function') safeOnDisconnectRef.cancel(); } catch(e){}
      } catch(e){
        console.warn("‚ö†Ô∏è pagehide: couldn't update meeting end (might be offline):", e);
      }
    }, {passive:true});
  }

  /* ---------------------------
      Friendly log to show that the API is ready
  ---------------------------- */
  api.addEventListener("readyToClose", () => {
    console.log("‚ÑπÔ∏è Jitsi API readyToClose event received");
  });

  console.log("‚úÖ Jitsi API initialized and event listeners attached.");
}

/* ---------------------------------------------------
    PATIENT AUTO EXIT ON END
--------------------------------------------------- */
function attachMeetingSync(){
  console.log("üîµ attachMeetingSync");

  const meetingRef = ref(database,"meetings/"+roomName);

  onValue(meetingRef, (snap)=>{
    if(!snap.exists()) {
      console.log("‚ö™ meetingRef empty");
      return;
    }

    const data = snap.val();
    console.log("üì° Firebase meeting update:", data);

    // If meeting ended remotely (doctor ended), patient should be redirected immediately.
    if (role === "patient" && data.status === "ended" && !alreadyRedirected) {
    alreadyRedirected = true;

    console.log("üî¥ Patient detected meeting ended in DB ‚Äî disposing Jitsi‚Ä¶");

    // üî• Dispose Jitsi iframe so patient leaves immediately
    try { 
        if (jitsiApi) { 
            jitsiApi.dispose(); 
            jitsiApi = null;
        }
    } catch (e) { 
        console.error("üî• Error disposing Jitsi:", e);
    }

    document.getElementById("meet").innerHTML =
      "<div class='ended-msg'>Meeting ended by doctor. Returning to dashboard‚Ä¶</div>";

    setTimeout(() => {
        window.location.replace("/dashboard.html");
    }, 600);
}
  });
}
</script>
</body>
</html>