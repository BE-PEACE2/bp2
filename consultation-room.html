<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>BE PEACE | Consultation Room</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="/style.css" />
  <style>
/* ===== BE PEACE CALM BACKGROUND ===== */
body {
  background: radial-gradient(circle at center, #ffeaf3 0%, #f8b6d0 55%, #ffffff 100%);
  animation: calmBreathe 10s ease-in-out infinite alternate;
  transition: background 1s ease-in-out;
  margin: 0;
  font-family: 'Inter', Arial, sans-serif;
}

@keyframes calmBreathe {
  0% {
    background: radial-gradient(circle at center, #fff7fa 0%, #fde3ef 50%, #ffffff 100%);
  }
  100% {
    background: radial-gradient(circle at center, #ffffff 0%, #fbe7f1 65%, #fff 100%);
  }
}

/* ===== MAIN LAYOUT ===== */
main { width:100%; height:calc(100vh - 120px); display:flex; justify-content:center; align-items:center; margin:0; padding:0; }
#meet {
  width:95%; height:85vh; border-radius:16px; overflow:hidden; background:#000; position:relative;
  transform:translate(40px,15px); transition:0.4s ease; box-shadow:0 0 60px 10px rgba(255,160,180,0.18);
  animation:calmGlow 6s ease-in-out infinite alternate;
}
@keyframes calmGlow {
  0% { box-shadow: 0 0 50px 8px rgba(255,170,185,0.18); }
  100% { box-shadow: 0 0 80px 16px rgba(255,145,165,0.28); }
}
#meet iframe { width:100%!important; height:100%!important; border:none; border-radius:16px; object-fit:cover; }
#meet .ended-msg { color:#fff; padding:20px; text-align:center; font-size:1.1rem; }

/* mobile */
@media(max-width:768px){
  #meet { width:100%; height:70vh; transform:translate(0,10px); border-radius:10px; }
}
</style>
</head>

<body>
<div id="header"></div>

<main>
  <div style="width:100%;">
    <div id="meet">Loading consultation room...</div>
  </div>
</main>

<div id="footer"></div>

<script src="https://meet.bepeace.in/external_api.js"></script>
<script src="/js/load-partials.js"></script>

<script type="module">
/* ---------------------------------------------------
    GLOBALS + CLEANUP
--------------------------------------------------- */
console.log("ðŸ”µ consultation-room loaded");

let jitsiApi = null;
let alreadyRedirected = false;

window.onbeforeunload = () => {
  console.log("ðŸ§¹ Cleaning Jitsi instanceâ€¦");
  if (jitsiApi) {
    try { jitsiApi.dispose(); } catch(e){}
    jitsiApi = null;
  }
};

/* ---------------------------------------------------
    FIREBASE INIT
--------------------------------------------------- */
import { auth, database } from "/js/firebase-init.js";
import { ref, get, set, update, onValue } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const params = new URLSearchParams(window.location.search);
const roomName = params.get("room");
const role = (params.get("role") || "patient").toLowerCase();
const urlPatientName = params.get("patientName") || "";
let displayName = "Guest";

console.log("ðŸŸ£ Room:", roomName);
console.log("ðŸŸ£ Role:", role);

if (!roomName) {
  console.log("âŒ No room, redirectingâ€¦");
  window.location.replace(role === "doctor" ? "/doctor-dashboard.html" : "/dashboard.html");
}

/* ---------------------------------------------------
    HELPERS
--------------------------------------------------- */
function toTitleCase(str){
  return str ? str.toLowerCase().split(" ").map(w=>w[0].toUpperCase()+w.slice(1)).join(" ") : "";
}

async function getPatientName(orderId){
  try{
    const snap = await get(ref(database,"bookings/"+orderId));
    return snap.exists() ? toTitleCase(snap.val().name) : "Guest Patient";
  } catch(e){
    return "Guest Patient";
  }
}

/* ---------------------------------------------------
    AUTH LISTENER
--------------------------------------------------- */
auth.onAuthStateChanged(async (user)=>{
  console.log("ðŸŸ¢ Firebase auth state:", user?.uid);

  if(role === "doctor" && user){
    try{
      const usr = (await get(ref(database,"users/"+user.uid))).val();
      displayName = usr?.name ? "Dr "+toTitleCase(usr.name) : "Dr "+toTitleCase((usr.email||"").split("@")[0]);
    }catch(e){ displayName="Dr Anonymous"; }
  } 
  else if(role === "patient"){
    displayName = urlPatientName.trim()
      ? toTitleCase(urlPatientName)
      : await getPatientName(roomName);
  }

  console.log("ðŸŸ¢ Final displayName:", displayName);

  initJitsi(displayName);
  attachMeetingSync();
});

/* ---------------------------------------------------
    INIT JITSI
--------------------------------------------------- */
function initJitsi(displayName){
  console.log("ðŸ”µ initJitsi");

  if(jitsiApi){
    console.log("âš ï¸ Jitsi exists, skipping");
    return;
  }

  document.querySelector("#meet").innerHTML = "";

  const domain = "meet.bepeace.in";
  const defaultButtons = ["microphone","camera","desktop","fullscreen","chat","raisehand","tileview"];
  const toolbarButtons = role==="doctor" ? [...defaultButtons,"hangup"] : defaultButtons;

  const options = {
    roomName,
    parentNode: document.querySelector("#meet"),
    userInfo: { displayName },
    width: "100%",
    height: "100%",
    lang: "en",

    configOverwrite: {
      prejoinPageEnabled: false,
      disableDeepLinking: true,
      startWithAudioMuted: false,
      startWithVideoMuted: false
    },

    interfaceConfigOverwrite: {
      SHOW_JITSI_WATERMARK: false,
      SHOW_POWERED_BY: false,
      TOOLBAR_BUTTONS: toolbarButtons,
      ENABLE_CLOSE_PAGE: false
    }
  };

  jitsiApi = new JitsiMeetExternalAPI(domain, options);
  const api = jitsiApi;

  /* ---------------------------
      JOINED EVENT
  ---------------------------- */
api.addEventListener("videoConferenceJoined", async () => {
  console.log("ðŸŸ¢ JITSI â€” videoConferenceJoined (role:", role, ")");

  try {
    const meetRef = ref(database, "meetings/" + roomName);
    const snap = await get(meetRef);
    const current = snap.exists() ? snap.val() : {};

    if (role === "doctor") {
      console.log("ðŸ©º Doctor joined â†’ mark meeting ongoing");

      await set(meetRef, {
        status: "ongoing",
        doctorJoined: true,
        patientJoined: current.patientJoined || false,
        startedAt: new Date().toISOString(),
        endedAt: null
      });
    }

    if (role === "patient") {
      console.log("ðŸ‘¶ Patient joined â†’ mark patientJoined");

      if (!current.patientJoined) {       // <-- IMPORTANT FIX
        await update(meetRef, {
          patientJoined: true
        });
        console.log("âœ… patientJoined updated");
      } else {
        console.log("âš ï¸ patientJoined already true â†’ NO update");
      }
    }
  } catch (e) {
    console.error("ðŸ”¥ Firebase update error:", e);
  }
});

  /* ---------------------------
      LEAVE EVENT
  ---------------------------- */
  api.addEventListener("participantLeft", async (event) => {
    console.log("ðŸ”´ participantLeft fired:", event);

    if (role !== "doctor") {
      console.log("â­• Patient left â€” NO meeting end trigger");
      return;
    }

    if (alreadyRedirected) {
      console.log("âš ï¸ Already redirected, skipping");
      return;
    }

    alreadyRedirected = true;

    console.log("ðŸ©º Doctor leaving â€” ENDING MEETINGâ€¦");

    try{
      await update(ref(database, "meetings/" + roomName), {
        status: "ended",
        doctorJoined: false,
        patientJoined: false,
        endedAt: new Date().toISOString()
      });
      console.log("ðŸ“¡ Meeting marked ended in Firebase");
    }catch(e){
      console.error("ðŸ”¥ Firebase meeting end error:", e);
    }

    console.log("âž¡ï¸ Redirect doctor to dashboard");
    window.location.replace("/doctor-dashboard.html");
  });
}

/* ---------------------------------------------------
    PATIENT AUTO EXIT ON END
--------------------------------------------------- */
function attachMeetingSync(){
  console.log("ðŸ”µ attachMeetingSync");

  const meetingRef = ref(database,"meetings/"+roomName);

  onValue(meetingRef, (snap)=>{
    if(!snap.exists()) {
      console.log("âšª meetingRef empty");
      return;
    }

    const data = snap.val();
    console.log("ðŸ“¡ Firebase meeting update:", data);

    if(role === "patient" && data.status === "ended" && !alreadyRedirected){
      alreadyRedirected = true;

      console.log("ðŸ”´ Patient detected meeting ended");

      document.getElementById("meet").innerHTML =
        "<div class='ended-msg'>Meeting ended by doctor. Returning to dashboardâ€¦</div>";

      setTimeout(()=>{
        window.location.replace("/dashboard.html");
      }, 900);
    }
  });
}

</script>
</body>
</html>