<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BE PEACE | Consultation Room</title>
  <link rel="stylesheet" href="/style.css" />
  <style>
    body, html { margin: 0; height: 100%; background: #f9f9f9; font-family: Arial, sans-serif; }
    header, footer { text-align: center; padding: 10px 0; }
    main { height: 85vh; display: flex; justify-content: center; align-items: center; }
    #meet { width: 95%; height: 90%; border-radius: 10px; overflow: hidden; }
    footer h2 {
  font-family: "Segoe UI", sans-serif;
  font-size: 18px;
  font-weight: 500;
  color: #c71585;
  text-shadow: 0 0 8px rgba(217, 27, 96, 0.2);
  margin-top: 6px;
  transition: all 0.3s ease;
}

footer h2:hover {
  text-shadow: 0 0 12px rgba(217, 27, 96, 0.4);
  transform: scale(1.02);
}

/* Prescription UI */
    #prescriptionBox {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 320px;
      background: #fff;
      padding: 16px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      display: none;
      z-index: 1000;
    }
    #prescriptionBox h4 {
      margin: 0 0 8px;
      color: #c71585;
      text-align: center;
    }
    #prescriptionBox textarea {
      width: 100%;
      margin-bottom: 8px;
      padding: 6px;
      border-radius: 6px;
      border: 1px solid #ddd;
      resize: vertical;
      font-family: Arial, sans-serif;
    }
    #prescriptionBox button {
      background: #c71585;
      color: white;
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      width: 100%;
    }
    #openPrescBtn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #c71585;
      color: white;
      padding: 12px 16px;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      font-size: 20px;
      z-index: 999;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body>
  <!-- HEADER -->
  <header>
    <div class="logo-container">
      <div class="earth"></div>
      <h1 class="peach-text">BE PEACE</h1>
    </div>
    <h2 style="color:#c71585;">Live Consultation Room</h2>
  </header>

  <main>
    <div id="meet">Loading consultation room...</div>
  </main>

<!-- ðŸŒ FOOTER (same style as header) -->
<footer>
  <div class="logo-container">
    <div class="earth slow"></div>
    <h1 class="peach-text">BE PEACE</h1>
  </div>
  <h2>Thank you for your trust â€” Your Health, Your Peace</h2>
</footer>

 <!-- ðŸ’Š Floating Prescription UI -->
  <div id="prescriptionBox">
    <h4>ðŸ©º Write Prescription</h4>
    <textarea id="diagnosis" placeholder="Diagnosis"></textarea>
    <textarea id="medicines" placeholder="Medicines"></textarea>
    <textarea id="advice" placeholder="Advice"></textarea>
    <button id="savePrescBtn">ðŸ’¾ Save Prescription</button>
  </div>

  <!-- ðŸ’Š Floating Button -->
<button id="openPrescBtn">ðŸ’Š</button>

  <!-- âœ… Use your own Jitsi server -->
  <script src="https://meet.bepeace.in/external_api.js"></script>
  
  <script type="module">
    import { auth, database } from "/js/firebase-init.js";
    import { ref, push } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js";
    
    // âœ… Read parameters from URL
    const urlParams = new URLSearchParams(window.location.search);
    const roomName = urlParams.get("room") || "BePeaceConsultation";
    const orderId = urlParams.get("orderId") || "manual";
    const patientUid = urlParams.get("uid") || ""; // from booking if passed
    const name = urlParams.get("name") || "Patient";

    console.log("Joining Room:", roomName, "as", name, "Order:", orderId);

    // âœ… Embed Jitsi directly (skip second page)
    const domain = "meet.bepeace.in";
    const options = {
      roomName: roomName,
      width: "100%",
      height: "100%",
      parentNode: document.querySelector("#meet"),
      userInfo: { displayName: name },
      configOverwrite: {
        prejoinPageEnabled: false, // ðŸ‘ˆ Skips the second screen
        disableDeepLinking: true,
        startWithAudioMuted: false,
        startWithVideoMuted: false,
        disableInviteFunctions: true,
      },
      interfaceConfigOverwrite: {
        SHOW_JITSI_WATERMARK: false,
        SHOW_BRAND_WATERMARK: false,
        SHOW_WATERMARK_FOR_GUESTS: false,
        TOOLBAR_BUTTONS: [
          'microphone', 'camera', 'chat', 'desktop', 'hangup', 'tileview'
        ],
      }
    };

    const api = new JitsiMeetExternalAPI(domain, options);

    // âœ… When the doctor or patient ends the call
    api.addEventListener("readyToClose", async () => {
      if (orderId) {
        await fetch("/api/waiting?path=end", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ orderId })
        });
      }
      alert("Consultation ended. Thank you for using BE PEACE.");
      window.location.href = "/thank-you.html";
    });

    // ðŸ’Š Prescription Logic
    const openBtn = document.getElementById("openPrescBtn");
    const box = document.getElementById("prescriptionBox");
    const saveBtn = document.getElementById("savePrescBtn");

    openBtn.onclick = () => {
      box.style.display = box.style.display === "none" ? "block" : "none";
    };

    saveBtn.onclick = async () => {
      const diagnosis = document.getElementById("diagnosis").value.trim();
      const medicines = document.getElementById("medicines").value.trim();
      const advice = document.getElementById("advice").value.trim();

      if (!diagnosis || !medicines) {
        alert("Please fill diagnosis and medicines.");
        return;
      }

      const user = auth.currentUser;
      if (!user) {
        alert("Please log in again.");
        return;
      }

      const path = patientUid
        ? `prescriptions/${patientUid}/${orderId}`
        : `prescriptions/${user.uid}/${orderId}`;

      await push(ref(database, path), {
        doctorUid: user.uid,
        doctorName: user.displayName || "Dr. Unknown",
        diagnosis,
        medicines,
        advice,
        orderId,
        createdAt: new Date().toISOString(),
      });

      alert("âœ… Prescription saved successfully!");
      box.style.display = "none";
      document.getElementById("diagnosis").value = "";
      document.getElementById("medicines").value = "";
      document.getElementById("advice").value = "";
    };
  </script>
</body>
</html>