<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>BE PEACE | Consultation Room</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="/style.css" />
  <style>
/* ===== BE PEACE CALM BACKGROUND ===== */
body {
  background: radial-gradient(circle at center, #ffeaf3 0%, #f8b6d0 55%, #ffffff 100%);
  animation: calmBreathe 10s ease-in-out infinite alternate;
  transition: background 1s ease-in-out;
  margin: 0;
  font-family: 'Inter', Arial, sans-serif;
}

@keyframes calmBreathe {
  0% {
    background: radial-gradient(circle at center, #fff7fa 0%, #fde3ef 50%, #ffffff 100%);
  }
  100% {
    background: radial-gradient(circle at center, #ffffff 0%, #fbe7f1 65%, #fff 100%);
  }
}

/* ===== MAIN LAYOUT ===== */
main { width:100%; height:calc(100vh - 120px); display:flex; justify-content:center; align-items:center; margin:0; padding:0; }
#meet {
  width:95%; height:85vh; border-radius:16px; overflow:hidden; background:#000; position:relative;
  transform:translate(40px,15px); transition:0.4s ease; box-shadow:0 0 60px 10px rgba(255,160,180,0.18);
  animation:calmGlow 6s ease-in-out infinite alternate;
}
@keyframes calmGlow {
  0% { box-shadow: 0 0 50px 8px rgba(255,170,185,0.18); }
  100% { box-shadow: 0 0 80px 16px rgba(255,145,165,0.28); }
}
#meet iframe { width:100%!important; height:100%!important; border:none; border-radius:16px; object-fit:cover; }
#meet .ended-msg { color:#fff; padding:20px; text-align:center; font-size:1.1rem; }

/* mobile */
@media(max-width:768px){
  #meet { width:100%; height:70vh; transform:translate(0,10px); border-radius:10px; }
}
</style>
</head>

<body>
<div id="header"></div>

<main>
  <div style="width:100%;">
    <div id="meet">Loading consultation room...</div>
  </div>
</main>

<div id="footer"></div>

<script src="https://meet.bepeace.in/external_api.js"></script>
<script src="/js/load-partials.js"></script>

<script type="module">
/* ---------------------------------------------------
    GLOBALS + CLEANUP
--------------------------------------------------- */
console.log("üîµ consultation-room loaded");

let jitsiApi = null;
let alreadyRedirected = false;
let safeOnDisconnectRef = null; // hold onDisconnect handler reference
let meetingSyncListenerAttached = false; // prevent duplicate listeners

/* ---------------------------------------------------
    PREVENT DUPLICATE WINDOWS/TABS
--------------------------------------------------- */
const paramsForDupCheck = new URLSearchParams(window.location.search);
const roomNameForDup = paramsForDupCheck.get("room");
const roleForDup = (paramsForDupCheck.get("role") || "patient").toLowerCase();
const sessionKey = roomNameForDup ? `consultation_${roomNameForDup}_${roleForDup}` : null;
const channelName = roomNameForDup ? `consultation_${roomNameForDup}_${roleForDup}` : null;

// ‚úÖ Check if another instance is already open
function checkForDuplicateWindow(roomName, role) {
  if (!roomName || !sessionKey) return false;
  
  // Check sessionStorage first
  const existingInstance = sessionStorage.getItem(sessionKey);
  if (existingInstance) {
    const data = JSON.parse(existingInstance);
    const now = Date.now();
    // If instance is less than 5 seconds old, it's likely a duplicate
    if (now - data.timestamp < 5000) {
      console.warn("‚ö†Ô∏è Duplicate consultation window detected!");
      showDuplicateMessage(role);
      return true;
    }
  }
  
  // Register this instance
  sessionStorage.setItem(sessionKey, JSON.stringify({
    timestamp: Date.now(),
    url: window.location.href
  }));
  
  // Use BroadcastChannel to communicate with other tabs
  try {
    const channel = new BroadcastChannel(channelName);
    
    // Listen for other instances trying to open
    channel.onmessage = (event) => {
      if (event.data.type === 'ping') {
        // Another tab is checking - respond that we're here
        channel.postMessage({ type: 'pong', timestamp: Date.now() });
        // If we're the newer instance, close ourselves
        if (event.data.timestamp < Date.now() - 2000) {
          console.warn("‚ö†Ô∏è Another consultation window is already open!");
          showDuplicateMessage(role);
        }
      } else if (event.data.type === 'pong') {
        // Another instance responded - we're the duplicate
        console.warn("‚ö†Ô∏è Another consultation window is already open!");
        showDuplicateMessage(role);
      }
    };
    
    // Broadcast that we're opening
    channel.postMessage({ type: 'ping', timestamp: Date.now() });
    
    // Clean up on unload
    window.addEventListener('beforeunload', () => {
      if (sessionKey) sessionStorage.removeItem(sessionKey);
      channel.close();
    });
    
    // Store channel reference for cleanup
    window.consultationChannel = channel;
  } catch (e) {
    console.warn("‚ö†Ô∏è BroadcastChannel not supported, using sessionStorage only:", e);
  }
  
  return false;
}

// ‚úÖ Show message and redirect if duplicate detected
function showDuplicateMessage(role) {
  const meetEl = document.getElementById("meet");
  if (meetEl) {
    meetEl.innerHTML = `
      <div class='ended-msg' style='padding:40px; text-align:center;'>
        <h2 style='color:#fff; margin-bottom:20px;'>‚ö†Ô∏è Consultation Already Open</h2>
        <p style='color:#fff; font-size:16px; margin-bottom:20px;'>
          Another consultation window is already open for this meeting.
        </p>
        <p style='color:#fff; font-size:14px; margin-bottom:30px;'>
          Please use the existing window or close it first.
        </p>
        <button onclick="window.location.replace('${role === 'doctor' ? '/doctor-dashboard.html' : '/dashboard.html'}')" 
                style='background:#c71585; color:#fff; padding:12px 24px; border:none; border-radius:8px; cursor:pointer; font-size:16px;'>
          Return to Dashboard
        </button>
      </div>
    `;
  }
  
  // Auto-redirect after 5 seconds
  setTimeout(() => {
    window.location.replace(role === "doctor" ? "/doctor-dashboard.html" : "/dashboard.html");
  }, 5000);
}

// ‚úÖ Prevent browser "leave page" confirmation dialogs
window.onbeforeunload = null;

// ‚úÖ Clean up on page unload (no confirmation dialog)
window.addEventListener('beforeunload', (e) => {
  // Don't show confirmation dialog - just clean up silently
  console.log("üßπ Cleaning up on page unload‚Ä¶");
  try {
    if (jitsiApi) {
      try { jitsiApi.dispose(); } catch(e){}
      jitsiApi = null;
    }
  } catch(e){
    console.warn("üß® Error while disposing jitsi:", e);
  }
  
  // ‚úÖ Clean up duplicate detection
  try {
    if (sessionKey) sessionStorage.removeItem(sessionKey);
    if (window.consultationChannel) {
      window.consultationChannel.close();
    }
  } catch(e) {
    console.warn("‚ö†Ô∏è Error cleaning up duplicate detection:", e);
  }
}, {passive: true});

/* ---------------------------------------------------
    FIREBASE INIT
--------------------------------------------------- */
import { auth, database } from "/js/firebase-init.js";
import { ref, get, set, update, onValue, onDisconnect, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const params = new URLSearchParams(window.location.search);
// Note: roomName and role are already defined in duplicate check above, but we need them here too
const roomNameForCheck = params.get("room");
const roleForCheck = (params.get("role") || "patient").toLowerCase();
const urlPatientName = params.get("patientName") || "";
let displayName = "Guest";

console.log("üü£ Room:", roomNameForCheck);
console.log("üü£ Role:", roleForCheck);

if (!roomNameForCheck) {
  console.log("‚ùå No room, redirecting‚Ä¶");
  window.location.replace(roleForCheck === "doctor" ? "/doctor-dashboard.html" : "/dashboard.html");
}

// Use the checked values
const roomName = roomNameForCheck;
const role = roleForCheck;

// ‚úÖ Check for duplicates immediately (after roomName and role are defined)
if (roomName && checkForDuplicateWindow(roomName, role)) {
  // Duplicate detected, stop execution
  // Don't throw error, just let the showDuplicateMessage handle it
}

/* ---------------------------------------------------
    HELPERS
--------------------------------------------------- */
function toTitleCase(str){
  return str ? str.toLowerCase().split(" ").map(w=>w[0].toUpperCase()+w.slice(1)).join(" ") : "";
}

async function getPatientName(orderId){
  try{
    const snap = await get(ref(database,"bookings/"+orderId));
    return snap.exists() ? toTitleCase(snap.val().name) : "Guest Patient";
  } catch(e){
    return "Guest Patient";
  }
}

/* ---------------------------------------------------
    AUTH LISTENER
--------------------------------------------------- */

// Attach immediately on page load
attachMeetingSync();
auth.onAuthStateChanged(async (user)=>{
  console.log("üü¢ Firebase auth state:", user?.uid);

  if(role === "doctor" && user){
    try{
      const usr = (await get(ref(database,"users/"+user.uid))).val();
      displayName = usr?.name ? "Dr "+toTitleCase(usr.name) : "Dr "+toTitleCase((usr.email||"").split("@")[0]);
    }catch(e){ displayName="Dr Anonymous"; }
  } 
  else if(role === "patient"){
    displayName = urlPatientName.trim()
      ? toTitleCase(urlPatientName)
      : await getPatientName(roomName);
  }

  console.log("üü¢ Final displayName:", displayName);

  initJitsi(displayName);
  
  // ‚úÖ Patient listener already set up early above (before auth)
  // Doctor doesn't need the pause listener
});

/* ---------------------------------------------------
    INIT JITSI
--------------------------------------------------- */
function initJitsi(displayName){
  console.log("üîµ initJitsi");

  if(jitsiApi){
    console.log("‚ö†Ô∏è Jitsi already initialized ‚Äî skipping re-init");
    return;
  }

  document.querySelector("#meet").innerHTML = "";

  const domain = "meet.bepeace.in";
  const defaultButtons = ["microphone","camera","desktop","fullscreen","chat","raisehand","tileview"];
  // ‚úÖ Only doctor gets hangup button - patient cannot end meeting
  const toolbarButtons = role==="doctor" ? [...defaultButtons,"hangup"] : defaultButtons;

  const options = {
    roomName,
    parentNode: document.querySelector("#meet"),
    userInfo: { displayName },
    width: "100%",
    height: "100%",
    lang: "en",

    configOverwrite: {
      prejoinPageEnabled: false,
      disableDeepLinking: true,
      startWithAudioMuted: false,
      startWithVideoMuted: false
    },

    interfaceConfigOverwrite: {
      SHOW_JITSI_WATERMARK: false,
      SHOW_POWERED_BY: false,
      TOOLBAR_BUTTONS: toolbarButtons,
      ENABLE_CLOSE_PAGE: false
    }
  };

  try {
    jitsiApi = new JitsiMeetExternalAPI(domain, options);
  } catch(e){
    console.error("üî• Failed to initialize JitsiMeetExternalAPI:", e);
    document.querySelector("#meet").innerHTML = "<div class='ended-msg'>Unable to start meeting. Please refresh or contact support.</div>";
    return;
  }

  const api = jitsiApi; // local alias for readability

  /* ---------------------------
      JOINED EVENT
  ---------------------------- */
  api.addEventListener("videoConferenceLeft", async () => {
  if (role !== "doctor") return;

  console.log("üü† Doctor videoConferenceLeft ‚Üí updating Firebase");

  try {
    await update(ref(database, "meetings/" + roomName), {
      status: "paused",
      doctorJoined: false,
      patientJoined: false,
      pausedAt: new Date().toISOString()
    });
    console.log("‚úÖ Firebase updated (paused) via videoConferenceLeft");
  } catch (e) {
    console.error("üî• Firebase update error:", e);
  }

  window.location.replace("/doctor-dashboard.html");
});

  /* ---------------------------
      PARTICIPANT LEFT - doctor-side triggers meeting end
      (participantLeft fires for any participant leaving; we only
       perform full meeting-end actions when this instance is doctor)
  ---------------------------- */
  api.addEventListener("participantLeft", async (event) => {
    console.log("üî¥ participantLeft fired:", event);

    // This handler can detect when other participants leave; only the doctor's page should treat it as meeting end.
    if (role !== "doctor") {
      console.log("‚≠ï This is not doctor instance ‚Äî ignoring participantLeft for meeting end.");
      return;
    }

    // If doctor left (meaning another participant left while doctor is present) we don't necessarily end meeting.
    // We only treat doctor's own leave via 'videoConferenceLeft' or hangup. participantLeft here is kept as an info log.
    console.log("‚ÑπÔ∏è Doctor instance detected participantLeft (no automatic meeting end from this event).");
  });

  /* ---------------------------
      HANGUP - Only doctor can end meeting
      When doctor ends meeting, both doctor and patient will be redirected
  ---------------------------- */
  api.addEventListener("hangup", async () => {
  if (role !== "doctor") return;

  console.log("ü©∫ Doctor hangup ‚Üí updating Firebase to paused");

  try {
    await update(ref(database, "meetings/" + roomName), {
      status: "paused",
      doctorJoined: false,
      patientJoined: false,
      pausedAt: new Date().toISOString()
    });
    console.log("‚úÖ Firebase updated (paused)");
  } catch (e) {
    console.error("üî• Firebase update error:", e);
  }

  try {
    if (jitsiApi) jitsiApi.dispose();
  } catch (e) {}

  window.location.replace("/doctor-dashboard.html");
});

  /* ---------------------------
      Ensure doctor's unload also marks meeting ended (best-effort)
  ---------------------------- */
  if (role === "doctor") {
    window.addEventListener("pagehide", async () => {
      console.log("üü† pagehide fired (doctor) ‚Äî attempting graceful end");
      if (alreadyRedirected) return;
      alreadyRedirected = true;
      try{
        // ‚úÖ Mark as paused (not ended) to allow rejoining
        await update(ref(database, "meetings/" + roomName), {
          status: "paused",
          doctorJoined: false,
          patientJoined: false,
          pausedAt: new Date().toISOString()
        });
        try { if (safeOnDisconnectRef && typeof safeOnDisconnectRef.cancel === 'function') safeOnDisconnectRef.cancel(); } catch(e){}
      } catch(e){
        console.warn("‚ö†Ô∏è pagehide: couldn't update meeting paused (might be offline):", e);
      }
    }, {passive:true});
  }

  /* ---------------------------
      Friendly log to show that the API is ready
  ---------------------------- */
  api.addEventListener("readyToClose", () => {
    console.log("‚ÑπÔ∏è Jitsi API readyToClose event received");
  });

  console.log("‚úÖ Jitsi API initialized and event listeners attached.");
}

/* ---------------------------------------------------
    PATIENT AUTO EXIT ON END
--------------------------------------------------- */
function attachMeetingSync(){
  // ‚úÖ Prevent duplicate listeners
  if (meetingSyncListenerAttached) {
    console.log("‚ö†Ô∏è Meeting sync listener already attached, skipping duplicate");
    return;
  }

  console.log("üîµ attachMeetingSync - Setting up Firebase listener for patient");

  if (!roomName) {
    console.warn("‚ö†Ô∏è No roomName, cannot attach meeting sync");
    return;
  }

  meetingSyncListenerAttached = true; // Mark as attached
  const meetingRef = ref(database,"meetings/"+roomName);

  // ‚úÖ Set up listener immediately - works even if meeting document doesn't exist yet
  // This ensures patient gets notified when doctor pauses, regardless of join order
  onValue(meetingRef, (snap)=>{
    if(!snap.exists()) {
      console.log("‚ö™ meetingRef empty - waiting for meeting to be created");
      return;
    }

    const data = snap.val();
    console.log("üì° Firebase meeting update:", data, "Current status:", data.status);

    // ‚úÖ If meeting paused remotely (doctor clicked hangup), patient should be redirected to patient dashboard
    // But they can rejoin if Join button is still active (time window allows)
    // Works regardless of who joined first - patient listener detects status change
    if (
  role === "patient" &&
  (data.status === "paused" || data.status === "ended") &&
  !alreadyRedirected
) {
      console.log("üî¥ PATIENT REDIRECT TRIGGERED - Status is paused, alreadyRedirected:", alreadyRedirected);
      alreadyRedirected = true;

      console.log("üî¥ Patient detected meeting paused by doctor ‚Äî disposing Jitsi and redirecting to patient dashboard (can rejoin if Join button active)‚Ä¶");

      // üî• Dispose Jitsi iframe silently (no user interaction needed)
      try { 
        if (jitsiApi) { 
          console.log("üî¥ Disposing Jitsi API...");
          jitsiApi.dispose(); 
          jitsiApi = null;
        }
      } catch (e) { 
        console.error("üî• Error disposing Jitsi:", e);
      }

      // ‚úÖ Clear sessionStorage to allow rejoining
      try {
        if (sessionKey) {
          sessionStorage.removeItem(sessionKey);
          console.log("‚úÖ Cleared sessionStorage to allow rejoining");
        }
        if (window.consultationChannel) {
          window.consultationChannel.close();
        }
      } catch(e) {
        console.warn("‚ö†Ô∏è Error clearing sessionStorage:", e);
      }

      // ‚úÖ Redirect immediately without any notification or delay
      // Use location.replace() to prevent back button navigation
      // Patient can rejoin by clicking Join button again if it's still active
      console.log("üî¥ Redirecting patient to dashboard immediately...");
      try {
        // Direct redirect - no setTimeout, no message, no confirmation
        // Patient will see Join button on dashboard if still within time window
        window.location.replace("/dashboard.html");
      } catch(e) {
        console.error("üî• Redirect failed, trying href:", e);
        window.location.href = "/dashboard.html";
      }
    } else if (role === "patient") {
      // Debug logging for patient
      if (data.status !== "paused") {
        console.log("‚ÑπÔ∏è Patient listener active - Meeting status:", data.status, "alreadyRedirected:", alreadyRedirected);
      }
    }
  }, (error) => {
    console.error("üî• Firebase listener error:", error);
  });
}
</script>
</body>
</html>