<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BE PEACE | Consultation Room</title>
  <link rel="stylesheet" href="/style.css" />
  <style>
    body, html { margin: 0; height: 100%; background: #f9f9f9; font-family: Arial, sans-serif; }
    header, footer { text-align: center; padding: 10px 0; }
    main { height: 85vh; display: flex; justify-content: center; align-items: center; }
    #meet { width: 95%; height: 90%; border-radius: 10px; overflow: hidden; }
  </style>
</head>
<body>
  <!-- HEADER -->
  <header>
    <div class="logo-container">
      <div class="earth"></div>
      <h1 class="peach-text">BE PEACE</h1>
    </div>
    <h2 style="color:#c71585;">Live Consultation Room</h2>
  </header>

  <main>
    <div id="meet">Loading consultation room...</div>
  </main>

  <!-- FOOTER -->
  <footer>
    <p>Â© 2025 BE PEACE. All rights reserved.</p>
  </footer>

  <!-- âœ… Use your own Jitsi server -->
  <script src="https://meet.bepeace.in/external_api.js"></script>
  <script>
    // âœ… Read parameters from URL
    const urlParams = new URLSearchParams(window.location.search);
    const roomName = urlParams.get("room") || "BePeaceConsultation";
    const orderId = urlParams.get("orderId") || "";
    const name = urlParams.get("name") || "Patient";

    console.log("Joining Room:", roomName, "as", name);

    // âœ… Embed Jitsi directly (skip second page)
    const domain = "meet.bepeace.in";
    const options = {
      roomName: roomName,
      width: "100%",
      height: "100%",
      parentNode: document.querySelector("#meet"),
      userInfo: { displayName: name },
      configOverwrite: {
        prejoinPageEnabled: false, // ðŸ‘ˆ Skips the second screen
        disableDeepLinking: true,
        startWithAudioMuted: false,
        startWithVideoMuted: false,
        disableInviteFunctions: true,
      },
      interfaceConfigOverwrite: {
        SHOW_JITSI_WATERMARK: false,
        SHOW_BRAND_WATERMARK: false,
        SHOW_WATERMARK_FOR_GUESTS: false,
        TOOLBAR_BUTTONS: [
          'microphone', 'camera', 'chat', 'desktop', 'hangup', 'tileview'
        ],
      }
    };

    const api = new JitsiMeetExternalAPI(domain, options);

    // âœ… When the doctor or patient ends the call
    api.addEventListener("readyToClose", async () => {
      if (orderId) {
        await fetch("/api/waiting?path=end", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ orderId })
        });
      }
      alert("Consultation ended. Thank you for using BE PEACE.");
      window.location.href = "/thank-you.html";
    });
  </script>
</body>
</html>