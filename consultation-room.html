<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>BE PEACE | Consultation Room</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="/style.css" />
  <style>
/* ===== BE PEACE CALM BACKGROUND ===== */
body {
  background: radial-gradient(circle at center, #ffeaf3 0%, #f8b6d0 55%, #ffffff 100%);
  animation: calmBreathe 10s ease-in-out infinite alternate;
  transition: background 1s ease-in-out;
  margin: 0;
  font-family: 'Inter', Arial, sans-serif;
}

@keyframes calmBreathe {
  0% {
    background: radial-gradient(circle at center, #fff7fa 0%, #fde3ef 50%, #ffffff 100%);
  }
  100% {
    background: radial-gradient(circle at center, #ffffff 0%, #fbe7f1 65%, #fff 100%);
  }
}

/* ===== MAIN LAYOUT ===== */
main { width:100%; height:calc(100vh - 120px); display:flex; justify-content:center; align-items:center; margin:0; padding:0; }
#meet {
  width:95%; height:85vh; border-radius:16px; overflow:hidden; background:#000; position:relative;
  transform:translate(40px,15px); transition:0.4s ease; box-shadow:0 0 60px 10px rgba(255,160,180,0.18);
  animation:calmGlow 6s ease-in-out infinite alternate;
}
@keyframes calmGlow {
  0% { box-shadow: 0 0 50px 8px rgba(255,170,185,0.18); }
  100% { box-shadow: 0 0 80px 16px rgba(255,145,165,0.28); }
}
#meet iframe { width:100%!important; height:100%!important; border:none; border-radius:16px; object-fit:cover; }
#meet .ended-msg { color:#fff; padding:20px; text-align:center; font-size:1.1rem; }

/* mobile */
@media(max-width:768px){
  #meet { width:100%; height:70vh; transform:translate(0,10px); border-radius:10px; }
}
</style>
</head>

<body>
<div id="header"></div>

<main>
  <div style="width:100%;">
    <div id="meet">Loading consultation room...</div>
  </div>
</main>

<div id="footer"></div>

<script src="https://meet.bepeace.in/external_api.js"></script>
<script src="/js/load-partials.js"></script>

<script type="module">
/* ---------------------------------------------------
    GLOBALS
--------------------------------------------------- */
let jitsiApi = null;
let alreadyRedirected = false;
let meetingSyncListenerAttached = false;

import { auth, database } from "/js/firebase-init.js";
import { ref, get, update, onValue } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const params = new URLSearchParams(window.location.search);
const roomName = params.get("room");
const role = (params.get("role") || "patient").toLowerCase();
const urlPatientName = params.get("patientName") || "";

/* ---------------------------------------------------
    REDIRECT IF NO ROOM
--------------------------------------------------- */
if (!roomName) {
  window.location.replace(role === "doctor" ? "/doctor-dashboard.html" : "/dashboard.html");
}

/* ---------------------------------------------------
    RESET OLD ENDED MEETING BEFORE ANY LOGIC
--------------------------------------------------- */
async function resetIfEnded() {
  const meetingRef = ref(database, "meetings/" + roomName);
  const snap = await get(meetingRef);

  if (snap.exists()) {
    const data = snap.val();

    if (data.status === "ended") {
      console.log("ðŸ”¥ Resetting old ended meeting...");
      await update(meetingRef, {
        status: "waiting",
        doctorJoined: false,
        patientJoined: false
      });
    }
  }
}

await resetIfEnded();
/* ---------------------------------------------------
    SAFE DUPLICATE CHECK (FINAL VERSION)
--------------------------------------------------- */
const sessionKey = "consult_" + roomName + "_" + role;

// First load â†’ mark as open
if (!sessionStorage.getItem(sessionKey)) {
    sessionStorage.setItem(sessionKey, "open");
    console.log("âœ” First tab opened");
} else if (sessionStorage.getItem(sessionKey) === "open") {
    // Second tab â†’ block
    console.log("âŒ Duplicate tab blocked");
    window.location.replace(role === "doctor" ? "/doctor-dashboard.html" : "/dashboard.html");
}

// On reload â†’ mark active but DO NOT block
sessionStorage.setItem(sessionKey, "active");

// Remove key on close
window.addEventListener("beforeunload", () => {
    sessionStorage.removeItem(sessionKey);
});

/* ---------------------------------------------------
    NAME BUILDER
--------------------------------------------------- */
async function getDisplayName(user) {
  if (role === "doctor") {
    const data = (await get(ref(database, "users/" + user.uid))).val();
    if (data?.name) return "Dr " + data.name;
    return "Dr " + (user.email?.split("@")[0] || "Anonymous");
  }

  if (urlPatientName.trim()) return urlPatientName.trim();

  const booking = await get(ref(database, "bookings/" + roomName));
  return booking.exists() ? booking.val().name : "Patient";
}

/* ---------------------------------------------------
    INIT JITSI
--------------------------------------------------- */
function initJitsi(displayName) {
  const domain = "meet.bepeace.in";
  const options = {
    roomName,
    parentNode: document.querySelector("#meet"),
    userInfo: { displayName },
    width: "100%",
    height: "100%",
    configOverwrite: { prejoinPageEnabled: false },
    interfaceConfigOverwrite: {
      TOOLBAR_BUTTONS:
        role === "doctor"
          ? ["microphone", "camera", "chat", "desktop", "tileview", "hangup"]
          : ["microphone", "camera", "chat", "desktop", "tileview"],
    },
  };

  jitsiApi = new JitsiMeetExternalAPI(domain, options);
  const api = jitsiApi;

  /* ---------------------------------------------------
      DOCTOR OR PATIENT LEAVES â†’ CLEAN END
--------------------------------------------------- */
  api.addEventListener("videoConferenceLeft", async () => {
    console.log("ðŸ”´ videoConferenceLeft fired");

    if (role === "doctor") {
      await update(ref(database, "meetings/" + roomName), {
        status: "ended",
        doctorJoined: false,
        patientJoined: false,
        endedAt: new Date().toISOString(),
      });
    }

    try { jitsiApi?.dispose(); } catch (e) {}

    window.location.replace(
      role === "doctor" ? "/doctor-dashboard.html" : "/dashboard.html"
    );
  });

  /* ---------------------------------------------------
      DOCTOR HANGUP BUTTON
--------------------------------------------------- */
  api.addEventListener("hangup", async () => {
    if (role !== "doctor") return;

    await update(ref(database, "meetings/" + roomName), {
      status: "ended",
      doctorJoined: false,
      patientJoined: false,
      endedAt: new Date().toISOString(),
    });

    try { jitsiApi?.dispose(); } catch (e) {}

    window.location.replace("/doctor-dashboard.html");
  });
}

/* ---------------------------------------------------
    PATIENT LISTENER â†’ doctor ended meeting
--------------------------------------------------- */
function attachMeetingSync() {
  if (meetingSyncListenerAttached) return;
  meetingSyncListenerAttached = true;

  const meetingRef = ref(database, "meetings/" + roomName);

  onValue(meetingRef, (snap) => {
    if (!snap.exists()) return;

    const data = snap.val();
    console.log("ðŸ“¡ Meeting:", data);


    // â­ Doctor ended meeting â†’ redirect patient (CASE-2 FIX)
    if (
      role === "patient" &&
      (data.status === "ended" || data.status === "paused") &&
      data.doctorJoined === true &&
      !alreadyRedirected
    ) {
      console.log("ðŸ”´ Doctor ended meeting â†’ patient redirect");

      alreadyRedirected = true;

      try {
        jitsiApi?.executeCommand("hangup");
        jitsiApi?.dispose();
      } catch (e) {}

      sessionStorage.removeItem(sessionKey);

      window.location.replace("/dashboard.html");
    }
  });
}

/* ---------------------------------------------------
    AUTH â†’ JOIN FLAGS + JITSI LOADING
--------------------------------------------------- */
attachMeetingSync();

auth.onAuthStateChanged(async (user) => {
  let displayName = "Guest";
  if (user) displayName = await getDisplayName(user);

/* ---------------------------------------------------
     ðŸ”¥ MARK DOCTOR JOINED (SAFE + PREVENTS LOOP)
--------------------------------------------------- */
if (role === "doctor" && user) {
  const meetingRef = ref(database, "meetings/" + roomName);
  const snap = await get(meetingRef);
  const data = snap.exists() ? snap.val() : {};

  // Only update if needed (prevents infinite Firebase loop)
  if (data.doctorJoined !== true || data.status !== "active") {
    console.log("ðŸŸ£ Doctor join â†’ updating meeting state");
    await update(meetingRef, {
      doctorJoined: true,
      status: "active"
    });
  } else {
    console.log("ðŸŸ¡ Doctor join skipped (already active)");
  }
}

/* ---------------------------------------------------
   ðŸ”¥ MARK PATIENT JOINED (FINAL FIX)
--------------------------------------------------- */
if (role === "patient") {
  const meetingRef = ref(database, "meetings/" + roomName);
  const snap = await get(meetingRef);
  const data = snap.exists() ? snap.val() : {};

  // Prevent overwriting doctorJoined accidentally
  await update(meetingRef, {
    patientJoined: true,
    status: "waiting"
  });

  console.log("ðŸŸ¢ Patient marked joined safely");
}

  /* ---------------------------------------------------
      INIT JITSI
  --------------------------------------------------- */
  initJitsi(displayName);
}); 
</script>
</body>
</html>