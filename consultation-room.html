<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BE PEACE | Consultation Room</title>
  <link rel="stylesheet" href="/style.css" />
  <style>
    body, html { margin: 0; height: 100%; background: #f9f9f9; font-family: Arial, sans-serif; }
    header, footer { text-align: center; padding: 10px 0; }
    main { height: 85vh; display: flex; justify-content: center; align-items: center; }
    #meet { width: 95%; height: 90%; border-radius: 10px; overflow: hidden; }
    footer h2 {
  font-family: "Segoe UI", sans-serif;
  font-size: 18px;
  font-weight: 500;
  color: #c71585;
  text-shadow: 0 0 8px rgba(217, 27, 96, 0.2);
  margin-top: 6px;
  transition: all 0.3s ease;
}

footer h2:hover {
  text-shadow: 0 0 12px rgba(217, 27, 96, 0.4);
  transform: scale(1.02);
}

/* Prescription UI */
    #prescriptionBox {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 320px;
      background: #fff;
      padding: 16px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      display: none;
      z-index: 1000;
    }
    #prescriptionBox h4 {
      margin: 0 0 8px;
      color: #c71585;
      text-align: center;
    }
    #prescriptionBox textarea {
      width: 100%;
      margin-bottom: 8px;
      padding: 6px;
      border-radius: 6px;
      border: 1px solid #ddd;
      resize: vertical;
      font-family: Arial, sans-serif;
    }
    #prescriptionBox button {
      background: #c71585;
      color: white;
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      width: 100%;
    }
    #openPrescBtn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #c71585;
      color: white;
      padding: 12px 16px;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      font-size: 20px;
      z-index: 999;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    .prescription-field {
  margin-bottom: 8px;
}
.prescription-label {
  font-weight: 600;
  color: #c71585;
  display: block;
  margin-bottom: 2px;
}
.prescription-value {
  background: #faf5f8;
  padding: 6px 8px;
  border-radius: 8px;
  font-size: 14px;
  color: #333;
  transition: background 0.4s ease;
}
.prescription-value.updated {
  background: #fff0f6;
}

  </style>
</head>
<body>
  <!-- HEADER -->
  <header>
    <div class="logo-container">
      <div class="earth"></div>
      <h1 class="peach-text">BE PEACE</h1>
    </div>
    <h2 style="color:#c71585;">Live Consultation Room</h2>
  </header>

  <main>
    <div id="meet">Loading consultation room...</div>
  </main>

<!-- üåç FOOTER (same style as header) -->
<footer>
  <div class="logo-container">
    <div class="earth slow"></div>
    <h1 class="peach-text">BE PEACE</h1>
  </div>
  <h2>Thank you for your trust ‚Äî Your Health, Your Peace</h2>
</footer>

 <!-- üíä Floating Prescription UI -->
  <div id="prescriptionBox">
    <h4>ü©∫ Write Prescription</h4>
    <textarea id="diagnosis" placeholder="Diagnosis"></textarea>
    <textarea id="medicines" placeholder="Medicines"></textarea>
    <textarea id="advice" placeholder="Advice"></textarea>
    <button id="savePrescBtn">üíæ Save Prescription</button>
  </div>

  <!-- üíä Floating Button -->
<button id="openPrescBtn">üíä</button>

  <!-- ‚úÖ Use your own Jitsi server -->
  <script src="https://meet.bepeace.in/external_api.js"></script>
  
  <script type="module">
    import { database } from "/js/firebase-init.js";
    import { ref, set, push, onValue } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js";

    const urlParams = new URLSearchParams(window.location.search);
    const roomName = urlParams.get("room") || "BePeaceConsultation";
    const role = urlParams.get("role") || "patient";
    const name = urlParams.get("name") || "User";
    const orderId = urlParams.get("orderId") || "manual";
    const patientUid = urlParams.get("uid") || ""; // if known

    console.log("Joining Room:", roomName, "as", role);

    // ‚úÖ Jitsi setup
    const domain = "meet.bepeace.in";
    const options = {
      roomName,
      width: "100%",
      height: "100%",
      parentNode: document.querySelector("#meet"),
      userInfo: { displayName: name },
      configOverwrite: { prejoinPageEnabled: false },
      interfaceConfigOverwrite: {
        SHOW_JITSI_WATERMARK: false,
        TOOLBAR_BUTTONS: ["microphone", "camera", "chat", "desktop", "hangup", "tileview"]
      }
    };
    const api = new JitsiMeetExternalAPI(domain, options);

    // Firebase live reference
    const liveRef = ref(database, `livePrescription/${roomName}`);
    const box = document.getElementById("prescriptionBox");
    const openBtn = document.getElementById("openPrescBtn");
    const diagnosisEl = document.getElementById("diagnosis");
    const medicinesEl = document.getElementById("medicines");
    const adviceEl = document.getElementById("advice");

    if (role === "doctor") {
      // üë®‚Äç‚öïÔ∏è Doctor: editable + auto-save on call end
      openBtn.style.display = "block";
      box.style.display = "none";

      const updateLive = () => {
        set(liveRef, {
          diagnosis: diagnosisEl.value,
          medicines: medicinesEl.value,
          advice: adviceEl.value,
          updatedAt: new Date().toISOString()
        });
      };
      [diagnosisEl, medicinesEl, adviceEl].forEach(el => el.addEventListener("input", updateLive));

      // ‚úÖ Save final copy when call ends ‚Äî now includes digital signature + date
api.addEventListener("readyToClose", async () => {
  const now = new Date();
  const formattedDate = now.toLocaleDateString("en-IN", {
    day: "2-digit",
    month: "short",
    year: "numeric"
  });

  const finalData = {
  doctorName: name,
  patientName: urlParams.get("patientName") || "Patient",
  patientAge: urlParams.get("patientAge") || "",
  patientGender: urlParams.get("patientGender") || "",
  diagnosis: diagnosisEl.value,
  medicines: medicinesEl.value,
  advice: adviceEl.value,
  doctorSignature: `Digitally signed by ${name} (BE PEACE)`,
  date: formattedDate,
  orderId,
  createdAt: now.toISOString()
};

  if (patientUid) {
    const presRef = push(ref(database, `prescriptions/${patientUid}`));
    await set(presRef, finalData);
  }

  alert("‚úÖ Consultation ended. Prescription saved with signature.");
  window.location.href = "/doctor-dashboard.html?tab=prescriptions";
});
    } else {
      // üë©‚Äçü¶∞ Patient: live read-only
openBtn.style.display = "none";
box.style.display = "block";
box.innerHTML = `
  <h4>üíä Live Prescription</h4>
  <div class="prescription-field">
    <span class="prescription-label">Diagnosis:</span>
    <div id="liveDiagnosis" class="prescription-value">Waiting...</div>
  </div>
  <div class="prescription-field">
    <span class="prescription-label">Medicines:</span>
    <div id="liveMedicines" class="prescription-value">‚Äì</div>
  </div>
  <div class="prescription-field">
    <span class="prescription-label">Advice:</span>
    <div id="liveAdvice" class="prescription-value">‚Äì</div>
  </div>
  <p style="font-size:12px;text-align:center;color:#999;">Auto-updating ü©∫</p>
`;

// ü©∫ Define references *after* creating innerHTML
const liveDiagnosis = document.getElementById("liveDiagnosis");
const liveMedicines = document.getElementById("liveMedicines");
const liveAdvice = document.getElementById("liveAdvice");

// ‚ú® Live calm animation
onValue(liveRef, (snapshot) => {
  const data = snapshot.val() || {};

  [liveDiagnosis, liveMedicines, liveAdvice].forEach((el) => el.classList.remove("updated"));
  
  setTimeout(() => {
    liveDiagnosis.textContent = data.diagnosis || "Waiting...";
    liveMedicines.textContent = data.medicines || "‚Äì";
    liveAdvice.textContent = data.advice || "‚Äì";

    [liveDiagnosis, liveMedicines, liveAdvice].forEach((el) => el.classList.add("updated"));
  }, 100);
});
    }

    // üå∏ When patient meeting ends
api.addEventListener("readyToClose", () => {
  alert("üå∏ Your consultation has ended. You can view your prescription in the dashboard.");
  window.location.href = "/dashboard.html?tab=prescriptions";
});

    openBtn.onclick = () => {
      box.style.display = box.style.display === "none" ? "block" : "none";
    };
  </script>
</body>
</html>