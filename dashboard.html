<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Patient Dashboard | BePeace</title>

  <!-- Global styles if you have them -->
  <link rel="stylesheet" href="style.css"/>

  <style>
    /* ======= CLEAN LAYOUT ======= */
    :root { --brand:#c71585; --sky1:#87cefa; --sky2:#add8e6; }

    body.dashboard-page {
      background: #f7faff;
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: #1f2937;
    }

    /* Top bar */
    .topbar {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: linear-gradient(90deg, var(--sky1), var(--sky2));
      position: sticky;
      top: 0;
      z-index: 1001;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }
    .topbar .brand {
      font-weight: 800;
      letter-spacing: .5px;
      color: var(--brand);
      text-shadow: 0 0 8px rgba(199,21,133,.22);
    }
    .topbar .spacer { flex: 1; }

    .btn-pill {
      background: linear-gradient(135deg, #d6249f, var(--brand));
      color: #fff;
      padding: 7px 18px;
      border-radius: 20px;
      font-size: .92rem;
      font-weight: 600;
      border: none;
      cursor: pointer;
      box-shadow: 0 3px 10px rgba(0,0,0,.18);
      transition: all .25s ease;
    }
    .btn-pill:hover {
      background: linear-gradient(135deg, #ff52c2, #e3379a);
      transform: translateY(-2px);
      box-shadow: 0 4px 14px rgba(0,0,0,.28);
    }
    .btn-pill:active { transform: scale(.96); }

    /* ======= HAMBURGER + DRAWER ======= */
    #hamburgerBtn {
      position: relative;
      margin-top: 12px;
      margin-left: 4px;
      z-index: 2000;
    }
    .hamburger-dashboard {
      width: 28px;
      height: 22px;
      display: inline-flex;
      flex-direction: column;
      justify-content: space-between;
      cursor: pointer;
      user-select: none;
    }
    .hamburger-dashboard span {
      display: block;
      height: 3px;
      width: 100%;
      background: #333;
      border-radius: 3px;
      transition: all .25s ease;
    }
    .hamburger-dashboard.active span:nth-child(1) {
      transform: translateY(9.5px) rotate(45deg);
    }
    .hamburger-dashboard.active span:nth-child(2) { opacity: 0; }
    .hamburger-dashboard.active span:nth-child(3) {
      transform: translateY(-9.5px) rotate(-45deg);
    }

    .drawer-overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,.35);
      opacity: 0; pointer-events: none;
      transition: opacity .25s ease;
      z-index: 1000;
    }
    .drawer-overlay.show { opacity: 1; pointer-events: auto; }

    .drawer {
      position: fixed; top: 0; left: 0;
      height: 100dvh; width: 280px;
      background: linear-gradient(180deg, #a2e4f3, #d7f6ff);
      box-shadow: 4px 0 16px rgba(0,0,0,.12);
      padding: 22px 16px;
      transform: translateX(-100%);
      transition: transform .28s ease;
      z-index: 1001; overflow-y: auto;
    }
    .drawer.open { transform: translateX(0); }
    .drawer h2 {
      text-align: center; margin: 0 0 18px;
      color: var(--brand); font-size: 1.25rem; letter-spacing: .5px;
    }
    .drawer ul { list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:10px; }
    .drawer a {
      display: flex; align-items:center; justify-content: space-between;
      text-decoration: none; padding: 12px; border-radius: 10px;
      font-size: 0.98rem; color: #333; background: transparent; transition: .2s;
    }
    .drawer a:hover { background: rgba(255,255,255,0.8); transform: translateX(6px); }
    .drawer a.active { background: var(--brand); color:#fff; box-shadow: 0 3px 12px rgba(199,21,133,0.35); }

    .badge {
      display:inline-block; min-width:20px; padding:2px 8px;
      border-radius:999px; font-size:.78rem; font-weight:700;
      background:#aaa; color:#fff; margin-left:8px;
    }

    /* ======= MAIN (only greeting + poem) ======= */
    .dashboard-main {
      max-width: 980px;
      margin: 22px auto 60px;
      padding: 0 16px 40px;
    }
    .greeting {
      background: #fff;
      padding: 28px 22px;
      border-radius: 16px;
      box-shadow: 0 8px 26px rgba(0,0,0,.06);
      text-align: center;
    }
    .greeting h1 {
      margin: 0 0 10px;
      font-weight: 800;
      color: #1f2937;
      letter-spacing: .2px;
    }
    .poem {
      margin: 8px auto 0;
      max-width: 640px;
      line-height: 1.75;
      font-size: 1.05rem;
      color: #374151;
    }

    #header { position: relative; z-index: 1500; }
  </style>
</head>
<body class="dashboard-page">

  <!-- Optional header partial -->
  <div id="header"></div>

  <!-- Topbar with hamburger + brand + logout -->
  <div class="topbar">
    <div id="hamburgerBtn" class="hamburger-dashboard" aria-label="Open menu" role="button" tabindex="0">
      <span></span><span></span><span></span>
    </div>
    <div class="brand">BE PEACE</div>
    <div class="spacer"></div>
    <button id="logoutBtn" class="btn-pill">Logout</button>
  </div>

  <!-- LEFT DRAWER + OVERLAY -->
  <div id="drawerOverlay" class="drawer-overlay"></div>
  <nav id="sideDrawer" class="drawer" aria-label="Side navigation">
    <h2>BE PEACE</h2>
    <ul>
      <li><a href="dashboard.html" class="active">üè† Dashboard</a></li>
      <li>
        <details open>
          <summary>üìÖ Consultations</summary>
          <ul style="list-style:none; padding-left:12px; margin-top:8px;">
            <li>
              <a href="#" onclick="showSection('today')">
                 Today
               <span id="countToday" class="badge"></span>
             </a>
            </li>
            <li>
              <a href="#" onclick="showSection('upcoming')">
                 Upcoming
               <span id="countUpcoming" class="badge"></span>
              </a>
            </li>
            <li>
              <a href="#" onclick="showSection('past')">
                Past
             <span id="countPast" class="badge"></span>
           </a>
            </li>
          </ul>
        </details>
      </li>
      <li><a href="prescriptions.html" onclick="closeDrawer()">üíä Prescriptions</a></li>
      <li><a href="#" onclick="alert('Coming Soon!'); closeDrawer()">üßæ Receipts</a></li>
      <li><a href="#" onclick="logout(); closeDrawer()">üö™ Logout</a></li>
    </ul>
  </nav>

  <!-- MAIN (Clean: only greeting + poem) -->
  <main class="dashboard-main">
    <section class="greeting">
      <h1 id="greeting">Hello üëã</h1>
      <div class="poem" id="poem">
        May your breath soften today,<br/>
        and may your heart find a little more peace than yesterday.
      </div>
    </section>
    <section id="consultationContainer">
  <section id="today" class="panel" style="display:none;">
    <h2>Today's Consultations</h2>
    <div id="todayList"></div>
  </section>

  <section id="upcoming" class="panel" style="display:none;">
    <h2>Upcoming Consultations</h2>
    <div id="upcomingList"></div>
  </section>

  <section id="past" class="panel" style="display:none;">
    <h2>Past Consultations</h2>
    <div id="pastList"></div>
  </section>
</section>
  </main>

  <!-- Optional footer partial -->
  <div id="footer"></div>

  <!-- ======= Drawer JS (non-module) ======= -->
  <script>
    const drawer = document.getElementById('sideDrawer');
    const overlay = document.getElementById('drawerOverlay');
    const hamburger = document.getElementById('hamburgerBtn');

    function openDrawer() {
      drawer.classList.add('open');
      overlay.classList.add('show');
      hamburger.classList.add('active');
      document.documentElement.style.overflow = 'hidden';
    }
    function closeDrawer() {
      drawer.classList.remove('open');
      overlay.classList.remove('show');
      hamburger.classList.remove('active');
      document.documentElement.style.overflow = '';
    }
    function toggleDrawer() {
      if (drawer.classList.contains('open')) closeDrawer();
      else openDrawer();
    }
    window.closeDrawer = closeDrawer;

    hamburger.addEventListener('click', toggleDrawer);
    hamburger.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggleDrawer(); }
    });
    overlay.addEventListener('click', closeDrawer);
    window.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeDrawer(); });
  </script>

<script>
  window.showSection = function(sectionId) {

    // 1Ô∏è‚É£ Hide all sections first
    document.getElementById("today").style.display = "none";
    document.getElementById("upcoming").style.display = "none";
    document.getElementById("past").style.display = "none";

    // 2Ô∏è‚É£ Show selected section
    const section = document.getElementById(sectionId);
    if (section) section.style.display = "block";

    // 3Ô∏è‚É£ Scroll into view
    section.scrollIntoView({ behavior: "smooth", block: "start" });

    // 4Ô∏è‚É£ Close drawer
    closeDrawer();
  };
</script>

  <!-- ======= Firebase + Live Counts (module) ======= -->
  <script type="module">
    import { auth, database } from "./js/firebase-init.js";
    import { ref, onValue } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";
    import { signOut } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";

    const greetingEl = document.getElementById("greeting");
    const todayBadge = document.getElementById("countToday");
    const upcomingBadge = document.getElementById("countUpcoming");
    const pastBadge = document.getElementById("countPast");
    const logoutBtn = document.getElementById("logoutBtn");

    // Logout
    window.logout = async function () {
      try { await signOut(auth); window.location.href = "/index.html"; }
      catch (e) { alert("Logout failed: " + (e?.message || e)); }
    };
    logoutBtn.addEventListener("click", () => window.logout());

    // Helper: set greeting name (no time-based text)
    function setGreetingName(user) {
      if (!user) return;
      const nameFromAuth = user.displayName && user.displayName.trim();
      const nameFromEmail = user.email ? user.email.split("@")[0] : "";
      const pretty = (nameFromAuth || nameFromEmail || "Friend")
        .replace(/[._-]/g, " ")
        .replace(/\b\w/g, s => s.toUpperCase());
      greetingEl.textContent = `Hello ${pretty} üëã`;
    }

    // Helper: show counts only when > 0
    function updateBadge(el, count) {
      if (!el) return;
      if (count > 0) {
        el.textContent = count;
        el.style.background = "#c71585";
        el.style.color = "#fff";
      } else {
        el.textContent = "";
        el.style.background = "transparent";
      }
    }

    // Parse slot like "10:30 AM" ‚Üí 24h
    function parseTimeTo24H(timeStr) {
      if (!timeStr) return { hours: 0, minutes: 0 };
      const [time, modifier] = String(timeStr).split(" ");
      let [hours, minutes] = time.split(":").map(Number);
      if (modifier === "PM" && hours !== 12) hours += 12;
      if (modifier === "AM" && hours === 12) hours = 0;
      return { hours, minutes };
    }

    auth.onAuthStateChanged((user) => {
      if (!user) return;
      setGreetingName(user);

      const bookingsRef = ref(database, "bookings");
      onValue(bookingsRef, (snapshot) => {
        const data = snapshot.val() || {};
        const now = new Date();

        let countToday = 0, countUpcoming = 0, countPast = 0;

        Object.values(data).forEach((b) => {
          if (b.email !== user.email) return;
          if (!b.date || !b.slot) return;

          const { hours, minutes } = parseTimeTo24H(b.slot);
          const start = new Date(`${b.date}T${String(hours).padStart(2, "0")}:${String(minutes).padStart(2, "0")}:00`);
          const end = new Date(start.getTime() + 24 * 60 * 60 * 1000);

          if (now < start) countUpcoming++;
          else if (now >= start && now <= end) countToday++;
          else countPast++;
        });

        updateBadge(todayBadge, countToday);
        updateBadge(upcomingBadge, countUpcoming);
        updateBadge(pastBadge, countPast);
      });
    });
  </script>

  <!-- If you use header/footer partials elsewhere -->
  <script src="js/load-partials.js"></script>
</body>
</html>