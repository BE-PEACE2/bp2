<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Patient Dashboard | BePeace</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    /* ---------- LEFT SIDEBAR CLEAN LAYOUT ---------- */

    .dashboard-container {
      display: flex;
      width: 100%;
      min-height: 100vh;
      background: #f7faff;
    }

    /* ‚úÖ Fixed Left Sidebar */
    .sidebar-fixed {
      width: 240px;
      background: linear-gradient(180deg, #a2e4f3, #d7f6ff);
      padding: 25px 18px;
      box-shadow: 3px 0 12px rgba(0,0,0,0.1);
      position: fixed;
      top: 0;
      left: 0;
      bottom: 0;
      z-index: 50;
      overflow-y: auto;
    }

    .sidebar-fixed h2 {
      text-align: center;
      margin: 0 0 25px;
      color: #c71585;
      font-size: 1.4rem;
      letter-spacing: 1px;
    }

    .sidebar-fixed ul {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .sidebar-fixed a {
      display: block;
      text-decoration: none;
      padding: 12px;
      border-radius: 10px;
      font-size: 1rem;
      color: #333;
      background: transparent;
      transition: 0.25s;
    }

    .sidebar-fixed a:hover {
      background: rgba(255,255,255,0.8);
      transform: translateX(5px);
    }

    .sidebar-fixed a.active {
      background: #c71585;
      color: white;
      box-shadow: 0 3px 12px rgba(199,21,133,0.4);
    }

    /* ‚úÖ Main Content shifted right */
    .main-area {
      margin-left: 260px;
      padding: 30px 30px 90px;
      width: calc(100% - 260px);
    }

    /* ‚úÖ Greeting Card */
    .greeting-card {
      background: #fff;
      padding: 25px;
      border-radius: 14px;
      margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    }

    .greeting-card h1 {
      margin: 0;
      font-size: 2rem;
    }

    .panel {
      background: #fff;
      padding: 25px;
      border-radius: 12px;
      margin-top: 25px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    }

    .appointment {
      display: flex;
      justify-content: space-between;
      background: #f9f9f9;
      padding: 16px;
      border-radius: 10px;
      margin-top: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }

    /* ‚úÖ Mobile: use your existing hamburger drawer */
    @media (max-width: 900px) {
      .sidebar-fixed {
        display: none;
      }
      .main-area {
        margin-left: 0;
        width: 100%;
      }
    }
  </style>
</head>

<body class="dashboard-page">

  <!-- HEADER -->
  <div id="header"></div>

  <div class="hamburger-dashboard" onclick="toggleMenu()">
  <span></span>
  <span></span>
  <span></span>
</div>

  <!-- ‚úÖ NEW DASHBOARD STRUCTURE -->
  <div class="dashboard-container">

    <!-- ‚úÖ FIXED LEFT SIDEBAR -->
    <aside class="sidebar-fixed">
      <h2>BE PEACE</h2>

      <ul>
        <li><a href="dashboard.html" class="active">üè† Dashboard</a></li>

        <li>
          <details open>
            <summary style="cursor:pointer;">üìÖ Consultations</summary>
            <ul style="list-style:none; padding-left:12px; margin-top:10px;">
              <li><a href="#today">Today <span id="countToday" class="badge">0</span></a></li>
              <li><a href="#upcoming">Upcoming <span id="countUpcoming" class="badge">0</span></a></li>
              <li><a href="#past">Past <span id="countPast" class="badge">0</span></a></li>
            </ul>
          </details>
        </li>

        <li><a href="prescriptions.html">üíä Prescriptions</a></li>
        <li><a href="#" onclick="alert('Coming Soon!')">üßæ Receipts</a></li>
        <li><a href="#" onclick="logout()">üö™ Logout</a></li>
      </ul>
    </aside>

    <!-- ‚úÖ MAIN CONTENT -->
    <main class="main-area">

      <div class="greeting-card">
        <h1>Hello üëã</h1>
        <p>Welcome to your <strong style="color:#c71585;">BePeace</strong> Dashboard.</p>
      </div>

      <section id="today" class="panel">
        <h2>üìÖ Today‚Äôs Consultations</h2>
        <div id="todayList" class="booking-list">Loading...</div>
      </section>

      <section id="upcoming" class="panel">
        <h2>üîÆ Upcoming Consultations</h2>
        <div id="upcomingList" class="booking-list">Loading...</div>
      </section>

      <section id="past" class="panel">
        <h2>üïì Past Consultations</h2>
        <div id="pastList" class="booking-list"></div>
      </section>

    </main>

  </div>

  <!-- FOOTER -->
  <div id="footer"></div>

  <!-- ‚úÖ Keep your existing Firebase Logic exactly same -->
  <script type="module">
    import { auth, database } from "./js/firebase-init.js";
    import { ref, onValue } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

    const todayBadge = document.getElementById("countToday");
    const upcomingBadge = document.getElementById("countUpcoming");
    const pastBadge = document.getElementById("countPast");

    const todayList = document.getElementById("todayList");
    const upcomingList = document.getElementById("upcomingList");
    const pastList = document.getElementById("pastList");

    function parseTimeTo24H(timeStr) {
      if (!timeStr) return { hours: 0, minutes: 0 };
      const [time, modifier] = timeStr.split(" ");
      let [hours, minutes] = time.split(":").map(Number);
      if (modifier === "PM" && hours !== 12) hours += 12;
      if (modifier === "AM" && hours === 12) hours = 0;
      return { hours, minutes };
    }

    auth.onAuthStateChanged((user) => {
      if (!user) return;
      const userEmail = user.email;
      const bookingsRef = ref(database, "bookings");

      onValue(bookingsRef, (snapshot) => {
        const data = snapshot.val() || {};
        const now = new Date();

        todayList.innerHTML = "";
        upcomingList.innerHTML = "";
        pastList.innerHTML = "";

        let countToday = 0, countUpcoming = 0, countPast = 0;

        Object.values(data).forEach((b) => {
          if (b.email !== userEmail) return;
          if (!b.date || !b.slot) return;

          const { hours, minutes } = parseTimeTo24H(b.slot);
          const consultStart = new Date(`${b.date}T${String(hours).padStart(2, "0")}:${String(minutes).padStart(2, "0")}:00`);
          const consultEnd = new Date(consultStart.getTime() + 24 * 60 * 60 * 1000);

          let statusText = "";
          let targetList;
          let joinHTML = "";

          if (now < consultStart) {
            statusText = "üïí Upcoming";
            targetList = upcomingList;
            countUpcoming++;
          } else if (now >= consultStart && now <= consultEnd) {
            statusText = "‚úÖ Live (Active for 24 hours)";
            targetList = todayList;
            countToday++;

            const joinURL = `/consultation-room.html?room=${encodeURIComponent(b.order_id || b.email || b.name)}&role=patient&doctor=${encodeURIComponent(b.doctorEmail || "")}&patientName=${encodeURIComponent(b.name || "")}`;
            joinHTML = `<a href="${joinURL}" target="_blank" class="join-btn live">Join Now</a>`;
          } else {
            statusText = "üî¥ Completed";
            targetList = pastList;
            countPast++;
          }

          const div = document.createElement("div");
          div.className = "appointment";
          div.innerHTML = `
            <div>
              <strong>${b.name || "Patient"}</strong><br/>
              ${b.date} ‚Ä¢ ${b.slot}<br/>
              <small>${b.concern || ""}</small>
            </div>
            <div style="text-align:right;">
              ${statusText}<br/>
              ${joinHTML}
            </div>`;
          targetList.appendChild(div);
        });

        todayBadge.textContent = countToday;
        upcomingBadge.textContent = countUpcoming;
        pastBadge.textContent = countPast;

        [todayBadge, upcomingBadge, pastBadge].forEach((el) => {
          el.style.background = el.textContent === "0" ? "#aaa" : "#c71585";
        });
      });
    });

    setInterval(() => window.location.reload(), 5 * 60 * 1000);
  </script>

  <script src="js/load-partials.js"></script>

</body>
</html>