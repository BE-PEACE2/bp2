<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Patient Dashboard | BePeace</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body class="dashboard-page">

  <!-- HEADER -->
  <div id="header"></div>

  <!-- MAIN DASHBOARD CONTENT -->
  <div class="dashboard-content">
    <button class="menu-btn" onclick="toggleMenu()">â˜°</button>
    <div id="menuOverlay" class="menu-overlay" onclick="toggleMenu()"></div>

    <!-- SIDE MENU -->
    <nav class="side-menu" id="sideMenu">
      <h2>BE PEACE</h2>
      <ul>
        <li><a href="dashboard.html" class="active">ğŸ  Dashboard</a></li>
        <li>
          <details open>
            <summary>ğŸ“… Consultations</summary>
            <ul style="margin-top: 8px; list-style: none; padding-left: 12px;">
              <li><a href="#today" onclick="scrollToSection('today')">Today <span id="countToday" class="badge">0</span></a></li>
              <li><a href="#upcoming" onclick="scrollToSection('upcoming')">Upcoming <span id="countUpcoming" class="badge">0</span></a></li>
              <li><a href="#past" onclick="scrollToSection('past')">Past <span id="countPast" class="badge">0</span></a></li>
            </ul>
          </details>
        </li>
        <li><a href="prescriptions.html">ğŸ’Š Prescriptions</a></li>
        <li><a href="#" onclick="alert('Coming Soon!')">ğŸ§¾ Receipts</a></li>
        <li><a href="#" onclick="logout()">ğŸšª Logout</a></li>
      </ul>
    </nav>

    <!-- MAIN AREA -->
    <main class="dashboard-main">
      <section class="greeting">
        <h1 id="greeting">Hello ğŸ‘‹</h1>
        <p>Welcome to your <span style="color:#c71585;font-weight:bold;">BePeace</span> Dashboard.</p>
      </section>

      <section id="today" class="panel">
        <h2>ğŸ“… Todayâ€™s Consultations</h2>
        <div id="todayList" class="booking-list">Loading...</div>
      </section>

      <section id="upcoming" class="panel">
        <h2>ğŸ”® Upcoming Consultations</h2>
        <div id="upcomingList" class="booking-list">Loading...</div>
      </section>

      <section id="past" class="panel">
        <h2>ğŸ•“ Past Consultations</h2>
        <div id="pastList" class="booking-list"></div>
      </section>
    </main>
  </div>

  <!-- FOOTER -->
  <div id="footer"></div>

  <!-- MENU SCRIPT -->
  <script>
    window.toggleMenu = function () {
      const menu = document.getElementById("sideMenu");
      const overlay = document.getElementById("menuOverlay");
      const isOpen = menu.classList.toggle("show");
      overlay.classList.toggle("show", isOpen);
    };

    function closeMenu() {
      document.getElementById("sideMenu").classList.remove("show");
      document.getElementById("menuOverlay").classList.remove("show");
    }

    window.scrollToSection = function (id) {
      const el = document.querySelector("#" + id);
      if (el) {
        el.scrollIntoView({ behavior: "smooth" });
        closeMenu();
      }
    };
  </script>

  <!-- ğŸŒ¿ FIREBASE LOGIC -->
  <script type="module">
    import { auth, database } from "./js/firebase-init.js";
    import { ref, onValue } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

    const todayBadge = document.getElementById("countToday");
    const upcomingBadge = document.getElementById("countUpcoming");
    const pastBadge = document.getElementById("countPast");

    const todayList = document.getElementById("todayList");
    const upcomingList = document.getElementById("upcomingList");
    const pastList = document.getElementById("pastList");

    function parseTimeTo24H(timeStr) {
      if (!timeStr) return { hours: 0, minutes: 0 };
      const [time, modifier] = timeStr.split(" ");
      let [hours, minutes] = time.split(":").map(Number);
      if (modifier === "PM" && hours !== 12) hours += 12;
      if (modifier === "AM" && hours === 12) hours = 0;
      return { hours, minutes };
    }

    auth.onAuthStateChanged((user) => {
      if (!user) return;
      const userEmail = user.email;
      const bookingsRef = ref(database, "bookings");

      onValue(bookingsRef, (snapshot) => {
        const data = snapshot.val() || {};
        const now = new Date();

        todayList.innerHTML = "";
        upcomingList.innerHTML = "";
        pastList.innerHTML = "";

        let countToday = 0, countUpcoming = 0, countPast = 0;

        Object.values(data).forEach((b) => {
          if (b.email !== userEmail) return;
          if (!b.date || !b.slot) return;

          const { hours, minutes } = parseTimeTo24H(b.slot);
          const consultStart = new Date(`${b.date}T${String(hours).padStart(2, "0")}:${String(minutes).padStart(2, "0")}:00`);
          const consultEnd = new Date(consultStart.getTime() + 24 * 60 * 60 * 1000); // +24h
          
          let statusText = "";
          let targetList;
          let joinHTML = "";

          if (now < consultStart) {
            statusText = "ğŸ•’ Upcoming";
            targetList = upcomingList;
            countUpcoming++;
          } else if (now >= consultStart && now <= consultEnd) {
            statusText = "âœ… Live (Active for 24 hours)";
            targetList = todayList;
            countToday++;

            const joinURL = `/consultation-room.html?room=${encodeURIComponent(b.order_id || b.email || b.name)}&role=patient&doctor=${encodeURIComponent(b.doctorEmail || "")}&patientName=${encodeURIComponent(b.name || "")}`;
            joinHTML = `<a href="${joinURL}" target="_blank" class="join-btn live">Join Now</a>`;
          } else {
            statusText = "ğŸ”´ Completed";
            targetList = pastList;
            countPast++;
          }

          const div = document.createElement("div");
          div.className = "appointment";
          div.innerHTML = `
            <div>
              <strong>${b.name || "Patient"}</strong><br/>
              ${b.date} â€¢ ${b.slot}<br/>
              <small>${b.concern || ""}</small><br/>
              <small>${b.status || ""}</small>
            </div>
            <div style="text-align:right;">
              ${statusText}<br/>
              ${joinHTML}
            </div>`;
          targetList.appendChild(div);
        });

        todayBadge.textContent = countToday;
        upcomingBadge.textContent = countUpcoming;
        pastBadge.textContent = countPast;

        [todayBadge, upcomingBadge, pastBadge].forEach((el) => {
          el.style.background = el.textContent === "0" ? "#aaa" : "#c71585";
        });
      });
    });

    // optional: gentle refresh every 5 minutes
    setInterval(() => window.location.reload(), 5 * 60 * 1000);
  </script>

  <script src="js/load-partials.js"></script>
</body>
</html>