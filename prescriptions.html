<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Prescriptions | BePeace</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>

<body style="font-family: Poppins, sans-serif; background:#f9fbfd; margin:0;">

  <h2 style="text-align:center; color:#c71585; margin-top:20px;">üíä My Prescriptions</h2>
  <div id="prescriptionList" style="max-width:800px; margin:20px auto; background:#fff; padding:20px; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,0.1);">
    Loading prescriptions...
  </div>

  <script type="module">
    import { auth, database } from "./js/firebase-init.js";
    import { ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js";
    const { jsPDF } = window.jspdf;

    const list = document.getElementById("prescriptionList");

    auth.onAuthStateChanged((user) => {
      if (!user) {
        list.innerHTML = "<p>Please log in to view prescriptions.</p>";
        return;
      }

      const presRef = ref(database, "prescriptions/" + user.uid);
      onValue(presRef, (snapshot) => {
        const data = snapshot.val();
        if (!data) {
          list.innerHTML = "<p>No prescriptions yet.</p>";
          return;
        }

        list.innerHTML = Object.values(data).reverse().map(p => `
          <div style="border-bottom:1px solid #eee; padding:12px 0;">
            <h3 style="color:#c71585;">${new Date(p.createdAt).toLocaleString()}</h3>
            <p><b>Doctor:</b> ${p.doctorName}</p>
            <p><b>Diagnosis:</b> ${p.diagnosis}</p>
            <p><b>Medicines:</b><br>${p.medicines.replace(/\n/g, '<br>')}</p>
            <p><b>Advice:</b> ${p.advice}</p>
            <button onclick='downloadPdf(${JSON.stringify(p).replace(/"/g, "&quot;")})'>üßæ Download PDF</button>
          </div>
        `).join("");
      });
    });
   window.downloadPdf = async function(p) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  // === Load Logo (SVG) ===
  try {
    const logo = await fetch("./images/logo.svg");
    const svgText = await logo.text();
    const svgImage = new Image();
    const svgBlob = new Blob([svgText], { type: "image/svg+xml" });
    const svgUrl = URL.createObjectURL(svgBlob);
    svgImage.src = svgUrl;
    await new Promise((res) => (svgImage.onload = res));
    doc.addImage(svgImage, "SVG", 15, 10, 25, 25);
  } catch (err) {
    console.warn("‚ö†Ô∏è Logo not found, skipping:", err);
  }

  // === Header Text ===
  doc.setFontSize(16);
  doc.setTextColor(199, 21, 133);
  doc.text("BE PEACE Teleconsultation", 45, 20);
  doc.setFontSize(10);
  doc.setTextColor(90, 90, 90);
  doc.text("Your Health ‚Ä¢ Your Peace", 45, 26);
  doc.text("May this prescription bring you comfort and clarity üåø", 45, 32);

  // === Clinic Info (Right side) ===
  doc.setFontSize(11);
  doc.setTextColor(0, 0, 0);
  doc.text(`Dr. ${p.doctorName || "BePeace Doctor"}`, 150, 15);
  doc.text("BePeace Wellness Center", 150, 21);
  doc.text("www.bepeace.in", 150, 33);
  doc.text("Digitally Signed Prescription", 150, 39);
  doc.setDrawColor(220, 180, 200);
  doc.line(15, 45, 195, 45);

  // === Patient Info ===
  doc.setFontSize(12);
  let y = 55;
  doc.text(`Patient: ${p.patientName || "N/A"}`, 15, y);
  doc.text(`Age: ${p.patientAge || "-"}`, 80, y);
  doc.text(`Gender: ${p.patientGender || "-"}`, 120, y);
  doc.text(`Date: ${p.date || new Date(p.createdAt).toLocaleDateString("en-IN")}`, 160, y, { align: "right" });
  doc.line(15, y + 3, 195, y + 3);
  y += 12;

  // === Diagnosis ===
  doc.setFontSize(13);
  doc.setTextColor(0, 0, 0);
  doc.text("Diagnosis:", 15, y);
  doc.setFontSize(12);
  const diag = doc.splitTextToSize(p.diagnosis || "-", 170);
  doc.text(diag, 30, y + 6);
  y += diag.length * 6 + 12;

  // === Medicines ===
  doc.setFontSize(13);
  doc.text("Medicines:", 15, y);
  doc.setFontSize(12);
  const meds = doc.splitTextToSize(p.medicines || "-", 170);
  doc.text(meds, 30, y + 6);
  y += meds.length * 6 + 12;

  // === Advice ===
  doc.setFontSize(13);
  doc.text("Advice:", 15, y);
  doc.setFontSize(12);
  const advice = doc.splitTextToSize(p.advice || "-", 170);
  doc.text(advice, 30, y + 6);
  y += advice.length * 6 + 18;

  // === Signature Block ===
  doc.line(120, y, 190, y);
  doc.text(p.doctorSignature || `Digitally signed by ${p.doctorName}`, 120, y + 8);
  doc.text(`Date: ${p.date || new Date(p.createdAt).toLocaleDateString("en-IN")}`, 120, y + 14);

  // === Footer ===
  doc.setFontSize(10);
  doc.setTextColor(150, 150, 150);
  doc.text("Take a slow breath. Healing flows through peace.", 15, 278);
  doc.setTextColor(120, 120, 120);
  doc.text("Your healing begins the moment you feel calm.", 15, 285);
  doc.text("Generated with care by BE PEACE ‚Äî Your Health, Your Peace.", 15, 291);

  // === Watermark ===
  doc.setFontSize(38);
  doc.setTextColor(248, 220, 240);
  doc.text("BE PEACE", 35, 160, { angle: 30 });

  // === Save File ===
  const patient = (p.patientName || "Patient").replace(/\s+/g, "_");
  doc.save(`BePeace_Prescription_${patient}_${new Date(p.createdAt).toISOString()}.pdf`);
};
  </script>
</body>
</html>