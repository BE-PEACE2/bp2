<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Doctor Dashboard - BE PEACE</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style.css" />
  <style>
    body { font-family: Arial, Helvetica, sans-serif; margin: 0; background: #f9f9f9; }
    h2 { text-align: center; margin: 20px 0; color: #c71585; }
    .dashboard { max-width: 1200px; margin: 20px auto; background: #fff; border-radius: 10px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    table th, table td { border: 1px solid #ddd; padding: 10px; text-align: left; }
    table th { background: #f2f2f2; }
    .btn { display: inline-block; padding: 8px 12px; border-radius: 5px; text-decoration: none; color: #fff; font-size: 14px; border: none; cursor: pointer; }
    .btn-join { background: #28a745; }
    .btn-end { background: #888; }
    .btn-logout { background: #c00; float: right; margin-bottom: 10px; }
    .status { font-weight: bold; padding: 4px 8px; border-radius: 5px; }
    .status.SUCCESS, .status.PAID { background: #d4edda; color: #155724; }
    .status.FAILED { background: #f8d7da; color: #721c24; }
    .status.PENDING { background: #fff3cd; color: #856404; }
    .filters { margin-bottom: 15px; flex-wrap: wrap; display: flex; align-items: center; gap: 10px; }
    .filters label { font-weight: bold; }
    .filters select, .filters input { padding: 6px; }
    #summaryPanel, #walkinSummary { display: flex; justify-content: space-between; flex-wrap: wrap; margin: 20px 0; text-align: center; }
    #summaryPanel div, #walkinSummary div { flex: 1; padding: 15px; margin: 5px; border-radius: 8px; }
    #summaryPanel div { background: #f2f2f2; }
    #walkinSummary div:nth-child(1) { background: #e8f5e9; }
    #walkinSummary div:nth-child(2) { background: #fff8e1; }
    #walkinSummary div:nth-child(3) { background: #e3f2fd; }
    #walkinSummary div:nth-child(4) { background: #fce4ec; }
    #summaryPanel h3, #walkinSummary h3 { margin: 0 0 10px; color: #333; }
    #summaryPanel p, #walkinSummary p { font-size: 20px; font-weight: bold; margin: 0; }
    .past-row { background: #f8f9fa; color: #888; }
    td small { font-size: 13px; color: #555; }
    @media (max-width: 768px) {
      table, thead, tbody, th, td, tr { display: block; }
      tr { margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; padding: 8px; }
      td { border: none; }
    }
  </style>
</head>
<body>
  <!-- HEADER -->
  <header>
    <div class="logo-container">
      <div class="earth"></div>
      <h1 class="peach-text">BE PEACE</h1>
    </div>
  </header>

  <div class="dashboard">
    <h2>üë®‚Äç‚öïÔ∏è Doctor Dashboard</h2>
    <button class="btn btn-logout" onclick="logout()">Logout</button>

    <!-- üìä Appointment Summary -->
    <div id="summaryPanel">
      <div><h3>Today‚Äôs Bookings</h3><p id="todayBookings">0</p></div>
      <div><h3>Upcoming</h3><p id="upcomingBookings">0</p></div>
      <div><h3>Today‚Äôs Revenue</h3><p id="todayRevenue">‚Çπ0</p></div>
      <div><h3>This Month</h3><p id="monthRevenue">‚Çπ0</p></div>
    </div>

    <!-- ü©∫ Walk-in Summary -->
    <div id="walkinSummary">
      <div><h3>üü¢ Waiting</h3><p id="waitingCount">0</p></div>
      <div><h3>üü° Consulting</h3><p id="consultingCount">0</p></div>
      <div><h3>üü£ Completed Today</h3><p id="completedCount">0</p></div>
      <div><h3>üí∞ Revenue Today</h3><p id="revenueToday">‚Çπ0</p></div>
    </div>

    <!-- üîç Filters -->
    <div class="filters">
      <label>Status:</label>
      <select id="status" onchange="loadBookings()">
        <option value="ALL" selected>All</option>
        <option value="PAID">Paid</option>
        <option value="SUCCESS">Success</option>
        <option value="FAILED">Failed</option>
        <option value="PENDING">Pending</option>
      </select>

      <label>Date Range:</label>
      <select id="range" onchange="loadBookings()">
        <option value="TODAY">Today</option>
        <option value="7DAYS">Next 7 Days</option>
        <option value="30DAYS">Next 30 Days</option>
        <option value="ALL" selected>All Future</option>
        <option value="PAST">Past</option>
      </select>

      <label>Country:</label>
      <select id="country" onchange="loadBookings()">
        <option value="ALL" selected>All</option>
        <option value="India">India üáÆüá≥</option>
        <option value="United States">United States üá∫üá∏</option>
        <option value="United Arab Emirates">UAE üá¶üá™</option>
        <option value="United Kingdom">UK üá¨üáß</option>
      </select>

      <label>üîç</label>
      <input type="text" id="search" placeholder="Patient name or email" oninput="loadBookings()" />
    </div>

    <!-- üìÖ Appointment Table -->
    <div id="bookingContainer"><p>‚è≥ Loading bookings...</p></div>

    <!-- üë• Walk-in Waiting Room -->
    <section style="margin-top:30px;">
      <h3>üë• Live Walk-in Waiting Room</h3>
      <div id="liveQueue">Loading queue...</div>
    </section>
  </div>

  <!-- FOOTER -->
  <footer>
    <div class="footer-logo">
      <div class="earth slow"></div>
      <h1 class="peach-text">BE PEACE</h1>
    </div>
    <p>¬© 2025 BE PEACE. All rights reserved.</p>
  </footer>

  <!-- SCRIPT -->
  <script type="module">
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
import { getDatabase, ref, get, onValue } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";
import { app } from "/js/firebase-init.js";

const auth = getAuth(app);
const db = getDatabase(app);
const token = localStorage.getItem("doctorToken");

// ====== Gentle Alert Sound ======
const alertSound = new Audio("https://cdn.pixabay.com/download/audio/2022/03/15/audio_578bcb1c33.mp3?filename=soft-notification-1-106163.mp3");
alertSound.volume = 0.3;

// ====== Auth Check ======
onAuthStateChanged(auth, async (user) => {
  if (!user || user.uid !== token) {
    localStorage.removeItem("doctorToken");
    window.location.href = "login.html";
    return;
  }

  // Load doctor profile
  const userRef = ref(db, "users/" + user.uid);
  const snap = await get(userRef);
  if (snap.exists()) {
    const data = snap.val();
    const header = document.querySelector("h2");
    header.innerHTML = `üë®‚Äç‚öïÔ∏è Welcome, Dr. ${data.name || "Mahesh Yadav"}<br><small style="font-size:14px;color:#555;">${data.email}</small>`;
  }

  initDashboard();
});

// ====== Initialize Dashboard ======
function initDashboard() {
  setupRealtimeBookings();
  setupRealtimeQueue();
  loadWalkinSummary();
  setInterval(loadWalkinSummary, 8000);
}

// ====== Flag Helper ======
const flags = { 
  India:"üáÆüá≥", 
  "United States":"üá∫üá∏", 
  "United Arab Emirates":"üá¶üá™", 
  "United Kingdom":"üá¨üáß", 
  Unknown:"üåç" 
};
const flag = c => flags[c] || "üåç";

// ====== Realtime Bookings ======
let oldBookingCount = 0;
function setupRealtimeBookings() {
  const doctorEmail = "drmaheshyadav010145@gmail.com";
  const bookingsRef = ref(db, "bookings");

  onValue(bookingsRef, (snapshot) => {
    const data = snapshot.val() || {};
    const status = document.getElementById("status").value;
    const search = document.getElementById("search").value.trim().toLowerCase();
    const country = document.getElementById("country").value;

    const bookings = Object.values(data).filter((b) => {
      const matchDoctor = b.doctorEmail?.toLowerCase() === doctorEmail;
      const matchStatus = status === "ALL" || b.status === status;
      const matchCountry = country === "ALL" || b.country === country;
      const matchSearch =
        !search ||
        b.name?.toLowerCase().includes(search) ||
        b.email?.toLowerCase().includes(search);
      return matchDoctor && matchStatus && matchCountry && matchSearch;
    });

    // üîî Play sound for new bookings
    if (bookings.length > oldBookingCount) {
      alertSound.play().catch(() => {});
    }
    oldBookingCount = bookings.length;

    // === Update Summary ===
    const todayStr = new Date().toISOString().split("T")[0];
    const today = bookings.filter((b) => b.date === todayStr);
    const upcoming = bookings.filter((b) => b.date > todayStr);
    const monthRevenue = bookings.reduce((t, b) => t + (b.amount || 0), 0);
    const todayRevenue = today.reduce((t, b) => t + (b.amount || 0), 0);

    document.getElementById("todayBookings").innerText = today.length;
    document.getElementById("upcomingBookings").innerText = upcoming.length;
    document.getElementById("todayRevenue").innerText = "‚Çπ" + todayRevenue;
    document.getElementById("monthRevenue").innerText = "‚Çπ" + monthRevenue;

    // === Render Bookings Table ===
    const container = document.getElementById("bookingContainer");
    if (!bookings.length) {
      container.innerHTML = "<p>‚úÖ No bookings found.</p>";
      return;
    }

    let html = "<table><tr><th>Date</th><th>Time</th><th>Patient</th><th>Country</th><th>Contact</th><th>Status</th><th>Join</th></tr>";
    bookings.forEach((b) => {
      const past = b.date < todayStr;
      html += `
        <tr class="${past ? "past-row" : ""}">
          <td>${b.date}</td>
          <td><div>${b.slotIST || "-"}</div><small>üïí ${b.slotLocal || ""}</small></td>
          <td>${b.name || "-"}</td>
          <td>${flag(b.country)} ${b.country || "üåç"}</td>
          <td>${b.email || ""}<br>${b.phone || ""}</td>
          <td><span class="status ${b.status}">${b.status}</span></td>
          <td>${b.meetingLink && !past ? `<a class='btn btn-join' href='${b.meetingLink}' target='_blank'>Join</a>` : "-"}</td>
        </tr>`;
    });
    html += "</table>";
    container.innerHTML = html;
  });
}

// ====== Walk-in Summary ======
async function loadWalkinSummary() {
  const token = localStorage.getItem("doctorToken");
  try {
    const res = await fetch("/api/waiting?path=summary", { headers: { Authorization: `Bearer ${token}` } });
    const d = await res.json();
    if (!d.success) return;
    waitingCount.innerText = d.waitingCount;
    consultingCount.innerText = d.consultingCount;
    completedCount.innerText = d.completedToday;
    revenueToday.innerText = "‚Çπ" + d.revenueToday;
  } catch (e) {
    console.error("Summary error:", e);
  }
}

// ====== Realtime Walk-in Queue ======
let oldQueueCount = 0;
function setupRealtimeQueue() {
  const queueRef = ref(db, "waitingRoom");
  const liveQueue = document.getElementById("liveQueue");

  onValue(queueRef, (snapshot) => {
    const data = snapshot.val() || {};
    const list = Object.values(data);

    if (list.length > oldQueueCount) {
      alertSound.play().catch(() => {});
    }
    oldQueueCount = list.length;

    if (!list.length) {
      liveQueue.innerHTML = "<p>No walk-in patients waiting.</p>";
      return;
    }

    let html = "<table><tr><th>#</th><th>Name</th><th>Joined</th><th>Action</th></tr>";
    list.forEach((p, i) => {
      html += `
        <tr>
          <td>${i + 1}</td>
          <td>${p.name}</td>
          <td>${new Date(p.createdAt).toLocaleTimeString()}</td>
          <td>
            <button class='btn btn-join' onclick="startConsult('${p.orderId}')">Start</button>
            <button class='btn btn-end' onclick="endConsult('${p.orderId}')">End</button>
          </td>
        </tr>`;
    });
    html += "</table>";
    liveQueue.innerHTML = html;
  });
}

// ====== Start Consultation ======
window.startConsult = async function (orderId) {
  const token = localStorage.getItem("doctorToken");
  if (!confirm("Start consultation for this patient?")) return;
  try {
    const res = await fetch("/api/waiting?path=start", {
      method: "POST",
      headers: { Authorization: `Bearer ${token}`, "Content-Type": "application/json" },
      body: JSON.stringify({ orderId })
    });
    const d = await res.json();
    if (!d.success) {
      alert(d.message || "Error starting consultation.");
      return;
    }
    window.open(`/consult-room.html?room=${encodeURIComponent(d.roomName)}&orderId=${encodeURIComponent(orderId)}`, "_blank");
  } catch (err) {
    console.error(err);
  }
};

// ====== End Consultation ======
window.endConsult = async function (orderId) {
  const token = localStorage.getItem("doctorToken");
  if (!confirm("End this consultation?")) return;
  try {
    const res = await fetch("/api/waiting?path=end", {
      method: "POST",
      headers: { Authorization: `Bearer ${token}`, "Content-Type": "application/json" },
      body: JSON.stringify({ orderId })
    });
    const d = await res.json();
    if (d.success) alert("‚úÖ Consultation marked as done.");
    else alert("‚ùå " + (d.message || "Unable to end consultation."));
  } catch (err) {
    console.error(err);
  }
};

// ====== LOGOUT (Fixed) ======
window.logout = async function () {
  try {
    localStorage.removeItem("doctorToken");
    await signOut(auth);
    alert("You have been logged out successfully üåø");
    window.location.href = "login.html";
  } catch (err) {
    console.error("Logout error:", err);
    alert("Error while logging out. Please try again.");
  }
};
</script>
</body>
</html>