<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Doctor Dashboard - BE PEACE</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style.css" />
  <style>
    body { font-family: 'Poppins', sans-serif; margin: 0; background: #f9f9f9; }
    h2 { text-align: center; margin: 20px 0; color: #c71585; }
    .dashboard { max-width: 1200px; margin: 20px auto; background: #fff; border-radius: 10px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    table th, table td { border: 1px solid #ddd; padding: 10px; text-align: left; }
    table th { background: #f2f2f2; }
    .btn { display: inline-block; padding: 8px 12px; border-radius: 5px; text-decoration: none; color: #fff; font-size: 14px; border: none; cursor: pointer; }
    .btn-join { background: #28a745; }
    .btn-end { background: #888; }
    .btn-logout { background: #c00; float: right; margin-bottom: 10px; }
    .status { font-weight: bold; padding: 4px 8px; border-radius: 5px; }
    .status.SUCCESS, .status.PAID, .status.CONFIRMED { background: #d4edda; color: #155724; }
    .status.FAILED { background: #f8d7da; color: #721c24; }
    .status.PENDING { background: #fff3cd; color: #856404; }
    .filters { margin-bottom: 15px; flex-wrap: wrap; display: flex; align-items: center; gap: 10px; }
    .filters label { font-weight: bold; }
    .filters select, .filters input { padding: 6px; border-radius: 6px; border: 1px solid #ddd; }
    #summaryPanel { display: flex; justify-content: space-between; flex-wrap: wrap; margin: 20px 0; text-align: center; }
    #summaryPanel div { flex: 1; padding: 15px; margin: 5px; border-radius: 8px; background: #f2f2f2; }
    #summaryPanel h3 { margin: 0 0 10px; color: #333; }
    #summaryPanel p { font-size: 20px; font-weight: bold; margin: 0; }
    .past-row { background: #f8f9fa; color: #888; }
    td small { font-size: 13px; color: #555; }
    @media (max-width: 768px) {
      table, thead, tbody, th, td, tr { display: block; }
      tr { margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; padding: 8px; }
      td { border: none; }
    }
  </style>
</head>
<body>
  <!-- HEADER -->
  <header>
    <div class="logo-container">
      <div class="earth"></div>
      <h1 class="peach-text">BE PEACE</h1>
    </div>
  </header>

  <div class="dashboard">
    <h2>üë®‚Äç‚öïÔ∏è Doctor Dashboard</h2>
    <button class="btn btn-logout" onclick="logout()">Logout</button>

    <!-- üìä Appointment Summary -->
    <div id="summaryPanel">
      <div><h3>Today‚Äôs Bookings</h3><p id="todayBookings">0</p></div>
      <div><h3>Upcoming</h3><p id="upcomingBookings">0</p></div>
      <div><h3>Today‚Äôs Revenue</h3><p id="todayRevenue">‚Çπ0</p></div>
      <div><h3>This Month</h3><p id="monthRevenue">‚Çπ0</p></div>
    </div>

    <!-- üîç Filters -->
    <div class="filters">
      <label>Status:</label>
      <select id="status" onchange="applyFilters()">
        <option value="ALL">All</option>
        <option value="CONFIRMED">Confirmed</option>
        <option value="PAID">Paid</option>
        <option value="PENDING">Pending</option>
        <option value="FAILED">Failed</option>
      </select>

      <label>Date Range:</label>
      <select id="range" onchange="applyFilters()">
        <option value="ALL">All</option>
        <option value="TODAY">Today</option>
        <option value="UPCOMING">Upcoming</option>
        <option value="PAST">Past</option>
      </select>

      <label>üîç</label>
      <input type="text" id="search" placeholder="Patient name or email" oninput="applyFilters()" />
    </div>

    <!-- üìÖ Appointment Table -->
    <div id="bookingContainer"><p>‚è≥ Loading bookings...</p></div>
  </div>

  <!-- FOOTER -->
  <footer>
    <div class="footer-logo">
      <div class="earth slow"></div>
      <h1 class="peach-text">BE PEACE</h1>
    </div>
    <p>¬© 2025 BE PEACE. All rights reserved.</p>
  </footer>

  <!-- SCRIPT -->
  <script type="module">
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";
    import { app } from "/js/firebase-init.js";

    const auth = getAuth(app);
    const db = getDatabase(app);

    let BOOKINGS = [];

    const statusEl = document.getElementById("status");
    const rangeEl = document.getElementById("range");
    const searchEl = document.getElementById("search");
    const container = document.getElementById("bookingContainer");

    const todayBookingsEl = document.getElementById("todayBookings");
    const upcomingBookingsEl = document.getElementById("upcomingBookings");
    const todayRevenueEl = document.getElementById("todayRevenue");
    const monthRevenueEl = document.getElementById("monthRevenue");

    onAuthStateChanged(auth, (user) => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }
      document.querySelector("h2").innerHTML = `üë®‚Äç‚öïÔ∏è Welcome, Dr. MAHESH YADAV <br><small style="font-size:14px;color:#555;">${user.email}</small>`;
      const bookingsRef = ref(db, "bookings");
      onValue(bookingsRef, (snapshot) => {
        const val = snapshot.val() || {};
        BOOKINGS = Object.values(val).filter(b => b.doctorEmail === user.email || true);
        renderBookings();
      });
    });

    function renderBookings() {
      const status = statusEl.value;
      const range = rangeEl.value;
      const search = searchEl.value.trim().toLowerCase();
      const now = new Date();
      const todayStr = now.toISOString().split("T")[0];

      let filtered = BOOKINGS.filter(b => {
        if (status !== "ALL" && (b.status || "").toUpperCase() !== status) return false;
        if (search && !((b.name || "").toLowerCase().includes(search) || (b.email || "").toLowerCase().includes(search))) return false;
        if (range === "TODAY" && b.date !== todayStr) return false;
        if (range === "UPCOMING" && b.date <= todayStr) return false;
        if (range === "PAST" && b.date >= todayStr) return false;
        return true;
      });

      // Summary
      const todayBookings = BOOKINGS.filter(b => b.date === todayStr);
      const upcoming = BOOKINGS.filter(b => b.date > todayStr);
      const todayRevenue = todayBookings.reduce((t, b) => t + (Number(b.amount) || 0), 0);
      const monthRevenue = BOOKINGS.reduce((t, b) => t + (Number(b.amount) || 0), 0);

      todayBookingsEl.textContent = todayBookings.length;
      upcomingBookingsEl.textContent = upcoming.length;
      todayRevenueEl.textContent = "‚Çπ" + todayRevenue;
      monthRevenueEl.textContent = "‚Çπ" + monthRevenue;

      if (!filtered.length) {
        container.innerHTML = "<p>No bookings found.</p>";
        return;
      }

      let html = "<table><tr><th>Date</th><th>Time</th><th>Patient</th><th>Concern</th><th>Status</th><th>Join</th></tr>";
      filtered.forEach(b => {
        const joinLink =
          b.status?.toLowerCase() === "confirmed" && b.meetingLink
            ? `<a class='btn btn-join' href='/consult-room.html?room=${encodeURIComponent(b.meetingLink)}&role=doctor&patientName=${encodeURIComponent(b.name || "")}&orderId=${encodeURIComponent(b.order_id || "")}' target='_blank'>Join</a>`
            : "-";
        html += `<tr>
          <td>${b.date || "-"}</td>
          <td>${b.slot || "-"}</td>
          <td>${b.name || "-"}</td>
          <td>${b.concern || "-"}</td>
          <td><span class="status ${b.status}">${b.status || "-"}</span></td>
          <td>${joinLink}</td>
        </tr>`;
      });
      html += "</table>";
      container.innerHTML = html;
    }

    window.applyFilters = renderBookings;

    window.logout = function() {
      signOut(auth).then(() => {
        window.location.href = "login.html";
      });
    };
  </script>
</body>
</html>