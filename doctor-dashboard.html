<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Doctor Dashboard - BE PEACE</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style.css" />
  <style>
    body { font-family: 'Poppins', sans-serif; margin: 0; background: #f9f9f9; overflow-x: hidden; }
    h2 { text-align: center; margin: 20px 0; color: #c71585; }
    .dashboard { max-width: 1200px; margin: 20px auto; background: #fff; border-radius: 10px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    table th, table td { border: 1px solid #ddd; padding: 10px; text-align: left; }
    table th { background: #f2f2f2; }
    .btn { display: inline-block; padding: 8px 12px; border-radius: 5px; text-decoration: none; color: #fff; font-size: 14px; border: none; cursor: pointer; }
    .btn-join { background: #22c55e; }
    .btn-end { background: #ef4444; }
    .btn-disabled { background: #aaa; color: white; cursor: not-allowed; }
    .btn-logout { background: #c00; float: right; margin-bottom: 10px; }
    .status { font-weight: bold; padding: 4px 8px; border-radius: 6px; display: inline-block; text-transform: uppercase; }
    .status.LIVE { background: #22c55e; color: white; animation: pulse 1.5s infinite; }
    .status.IN_PROGRESS { background: #facc15; color: #78350f; }
    .status.UPCOMING { background: #60a5fa; color: white; }
    .status.COMPLETED { background: #cbd5e1; color: #1e293b; }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(34,197,94,0.4); }
      70% { box-shadow: 0 0 0 10px rgba(34,197,94,0); }
      100% { box-shadow: 0 0 0 0 rgba(34,197,94,0); }
    }
    #summaryPanel { display: flex; justify-content: space-between; flex-wrap: wrap; margin: 20px 0; text-align: center; }
    #summaryPanel div { flex: 1; padding: 15px; margin: 5px; border-radius: 8px; background: #f2f2f2; }
    #summaryPanel h3 { margin: 0 0 10px; color: #333; }
    #summaryPanel p { font-size: 20px; font-weight: bold; margin: 0; }
    td small { font-size: 13px; color: #555; }

    /* üîî Popup Notification */
    #notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #22c55e;
      color: white;
      padding: 14px 18px;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.15);
      opacity: 0;
      transform: translateY(-10px);
      transition: all 0.4s ease;
      z-index: 1000;
    }
    #notification.show {
      opacity: 1;
      transform: translateY(0);
    }
  </style>
</head>

<body>
  <header>
    <div class="logo-container">
      <h1 class="peach-text">BE PEACE</h1>
    </div>
  </header>

  <div class="dashboard">
    <h2>üë®‚Äç‚öïÔ∏è Doctor Dashboard</h2>
    <button class="btn btn-logout" onclick="logout()">Logout</button>

    <div id="summaryPanel">
      <div><h3>Today‚Äôs Bookings</h3><p id="todayBookings">0</p></div>
      <div><h3>Upcoming</h3><p id="upcomingBookings">0</p></div>
      <div><h3>Today‚Äôs Revenue</h3><p id="todayRevenue">‚Çπ0</p></div>
      <div><h3>This Month</h3><p id="monthRevenue">‚Çπ0</p></div>
    </div>

    <div id="bookingContainer"><p>‚è≥ Loading bookings...</p></div>
  </div>

  <div id="notification"></div>
  <audio id="notifySound" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg"></audio>

  <footer>
    <p>¬© 2025 BE PEACE. All rights reserved.</p>
  </footer>

  <script type="module">
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
    import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";
    import { app } from "/js/firebase-init.js";

    const auth = getAuth(app);
    const db = getDatabase(app);
    const container = document.getElementById("bookingContainer");
    const notifySound = document.getElementById("notifySound");
    const notifyPopup = document.getElementById("notification");
    let prevBookings = [];

    function showNotification(msg) {
      notifyPopup.textContent = msg;
      notifyPopup.classList.add("show");
      notifySound.play().catch(()=>{});
      setTimeout(() => notifyPopup.classList.remove("show"), 5000);
    }

    onAuthStateChanged(auth, (user) => {
      if (!user) return window.location.href = "login.html";
      const bookingsRef = ref(db, "bookings");

      onValue(bookingsRef, (snapshot) => {
        const data = snapshot.val() || {};
        const doctorBookings = Object.values(data).filter(b => b.doctorEmail === user.email);
        detectNewOrLive(doctorBookings);
        renderBookings(doctorBookings);
      });
    });

    function parseTimeTo24H(timeStr) {
      if (!timeStr) return { hours: 0, minutes: 0 };
      const [time, modifier] = timeStr.split(" ");
      let [hours, minutes] = time.split(":").map(Number);
      if (modifier === "PM" && hours !== 12) hours += 12;
      if (modifier === "AM" && hours === 12) hours = 0;
      return { hours, minutes };
    }

    function detectNewOrLive(bookings) {
      if (!prevBookings.length) {
        prevBookings = bookings;
        return;
      }

      // üîî Check for new bookings
      bookings.forEach(b => {
        if (!prevBookings.find(p => p.order_id === b.order_id)) {
          showNotification(`üÜï New booking: ${b.name} at ${b.slot}`);
        }

        // üîî Check for new LIVE
        const { hours, minutes } = parseTimeTo24H(b.slot);
        const start = new Date(`${b.date}T${String(hours).padStart(2,"0")}:${String(minutes).padStart(2,"0")}:00`);
        const end = new Date(start.getTime() + 24*60*60*1000);
        const now = new Date();
        if (now >= start && now <= end && !b._wasLiveNotified) {
          showNotification(`üî¥ LIVE consultation: ${b.name}`);
          b._wasLiveNotified = true;
        }
      });

      prevBookings = bookings;
    }

    function renderBookings(bookings) {
      const now = new Date();
      container.innerHTML = "<table><tr><th>Date</th><th>Time</th><th>Patient</th><th>Concern</th><th>Status</th><th>Actions</th></tr>";

      let countToday = 0, countUpcoming = 0, todayRevenue = 0, monthRevenue = 0;
      const todayStr = now.toISOString().split("T")[0];
      const currentMonth = now.getMonth();

      bookings.forEach(b => {
        const { hours, minutes } = parseTimeTo24H(b.slot);
        const start = new Date(`${b.date}T${String(hours).padStart(2,"0")}:${String(minutes).padStart(2,"0")}:00`);
        const end = new Date(start.getTime() + 24 * 60 * 60 * 1000);
        const canJoin = now >= start && now <= end;
        let statusClass = "UPCOMING", statusText = "üïí Upcoming", actionHTML = "";

        if (canJoin) {
          statusClass = "LIVE";
          statusText = "üü¢ LIVE (24h)";
          countToday++;
        } else if (now > end) {
          statusClass = "COMPLETED";
          statusText = "üîµ Completed";
        } else {
          countUpcoming++;
        }

        if (b.status === "IN_PROGRESS") {
          statusClass = "IN_PROGRESS";
          statusText = "üü° In Progress";
        }

        if (canJoin && (!b.status || b.status === "CONFIRMED")) {
          actionHTML = `
            <button class='btn btn-join' onclick="startConsultation('${b.order_id}', '${b.name}')">Start</button>
            <a href='/consultation-room.html?room=${b.order_id}&role=doctor&patientName=${b.name}' target='_blank' class='btn btn-join'>Join</a>`;
        } else if (b.status === "IN_PROGRESS" && now <= end) {
          actionHTML = `
            <button class='btn btn-end' onclick="endConsultation('${b.order_id}', '${b.name}')">End</button>
            <a href='/consultation-room.html?room=${b.order_id}&role=doctor&patientName=${b.name}' target='_blank' class='btn btn-join'>Rejoin</a>`;
        } else {
          actionHTML = `<button class='btn btn-disabled' disabled>Closed</button>`;
        }

        const fee = Number(b.fee || 0);
        const bDate = new Date(b.date);
        if (bDate.toISOString().split("T")[0] === todayStr) todayRevenue += fee;
        if (bDate.getMonth() === currentMonth) monthRevenue += fee;

        container.innerHTML += `
          <tr>
            <td>${b.date}</td>
            <td>${b.slot}</td>
            <td>${b.name}</td>
            <td>${b.concern || "-"}</td>
            <td><span class="status ${statusClass}">${statusText}</span></td>
            <td>${actionHTML}</td>
          </tr>`;
      });

      document.getElementById("todayBookings").textContent = countToday;
      document.getElementById("upcomingBookings").textContent = countUpcoming;
      document.getElementById("todayRevenue").textContent = `‚Çπ${todayRevenue}`;
      document.getElementById("monthRevenue").textContent = `‚Çπ${monthRevenue}`;
      container.innerHTML += "</table>";
    }

    window.startConsultation = async function (orderId, name) {
      const bookingsRef = ref(db, "bookings");
      onValue(bookingsRef, (snapshot) => {
        const data = snapshot.val() || {};
        const key = Object.keys(data).find(k => data[k].order_id === orderId);
        if (key) update(ref(db, "bookings/" + key), { status: "IN_PROGRESS" });
      }, { onlyOnce: true });
      showNotification(`‚úÖ Started consultation with ${name}`);
    };

    window.endConsultation = async function (orderId, name) {
      const bookingsRef = ref(db, "bookings");
      onValue(bookingsRef, (snapshot) => {
        const data = snapshot.val() || {};
        const key = Object.keys(data).find(k => data[k].order_id === orderId);
        if (key) update(ref(db, "bookings/" + key), { status: "COMPLETED" });
      }, { onlyOnce: true });
      showNotification(`üèÅ Ended consultation with ${name}`);
    };

    window.logout = function () {
      signOut(auth).then(() => window.location.href = "login.html");
    };
  </script>
</body>
</html>